<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è–èª•å¤šçŒœå¿Œ - CLASSIFIED</title>
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Caveat:wght@700&family=Noto+Serif+TC:wght@500;900&display=swap" rel="stylesheet">
    <style>
        /* --- è¦–è¦ºç³»çµ± (ä¿æŒä¸è®Š) --- */
        :root {
            --bg-blood: #1a0505;
            --paper: #f2e8d5;
            --folder-color: #e3d4b6;
            --ink: #2b1d1d;
            --accent-red: #8a0303;
            --seal-red: #b22222;
            --success-green: #2e5902;
            --fail-red: #8a0303;
            --font-en: 'Special Elite', monospace;
            --font-cn: 'Noto Serif TC', serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            background-color: var(--bg-blood);
            margin: 0; padding: 0; height: 100vh;
            display: flex; justify-content: center;
            font-family: var(--font-cn); color: var(--ink);
            overflow: hidden;
            background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url("https://www.transparenttextures.com/patterns/black-felt.png");
        }

        .container {
            width: 100%; max-width: 450px; height: 100%;
            background-color: var(--paper);
            position: relative;
            box-shadow: 0 0 60px rgba(0,0,0,0.9);
            display: flex; flex-direction: column;
            overflow-y: auto; overflow-x: hidden;
            background-image: url("https://www.transparenttextures.com/patterns/cream-paper.png");
        }
        
        .container::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            box-shadow: inset 0 0 80px rgba(62, 39, 35, 0.4);
            pointer-events: none; z-index: 5;
        }

        .page {
            display: none; flex-direction: column; align-items: center;
            padding: 25px; width: 100%; min-height: 100%;
            position: absolute; top: 0; left: 0;
            background: transparent; z-index: 10;
            padding-top: 60px; 
            padding-bottom: 80px;
            opacity: 0; transition: opacity 0.5s ease;
        }
        .page.active { display: flex; z-index: 20; opacity: 1; }

        /* --- è£é£¾å…ƒç´  --- */
        .magnifying-glass {
            position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg);
            width: 120px; height: 120px;
            border: 8px solid #333; border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 15px rgba(0,0,0,0.3), inset 0 0 20px rgba(255,255,255,0.5);
            z-index: 1;
        }
        .magnifying-glass::after {
            content: ''; position: absolute; bottom: -60px; right: -40px;
            width: 20px; height: 80px; background: #5d4037;
            transform: rotate(-45deg); border-radius: 5px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.5);
        }
        .scattered-paper {
            position: absolute; background: #fff; border: 1px solid #ccc;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
            font-family: var(--font-en); font-size: 0.5rem; color: #aaa;
            padding: 5px; display: flex; align-items: center; justify-content: center;
        }

        h1, h2 { font-family: var(--font-en); color: var(--ink); text-align: center; margin: 10px 0; }
        h1 { 
            font-size: 2.8rem; font-weight: 900;
            text-transform: uppercase; letter-spacing: 2px;
            margin-top: 100px;
            text-shadow: 2px 2px 0px rgba(138, 3, 3, 0.2);
            transform: rotate(-2deg);
        }
        h2 { font-size: 1.5rem; background: var(--ink); color: var(--paper); padding: 5px 15px; transform: skew(-5deg); margin-bottom: 20px; box-shadow: 3px 3px 0 rgba(0,0,0,0.2); }

        /* --- æª”æ¡ˆç¿»é–± --- */
        .file-viewer-wrapper {
            width: 100%; position: relative; min-height: 600px; height: auto; 
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            padding-top: 20px; padding-bottom: 100px; 
        }

        .dossier-folder {
            width: 90%; max-width: 360px; min-height: 500px; height: auto; 
            background: var(--folder-color); border: 1px solid #c0b090; border-radius: 2px 10px 2px 2px;
            position: relative; box-shadow: 5px 5px 15px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; align-items: center; padding: 30px 15px; 
            transition: transform 0.3s ease; margin-bottom: 20px;
        }
        .dossier-folder::before {
            content: 'CONFIDENTIAL'; position: absolute; top: -25px; left: 0;
            width: 120px; height: 25px; background: var(--folder-color); border: 1px solid #c0b090;
            border-bottom: none; border-radius: 5px 10px 0 0; font-size: 0.7rem;
            display: flex; align-items: center; justify-content: center; color: #888; font-family: var(--font-en);
        }

        .dossier-name { font-family: var(--font-en); font-size: 2.2rem; font-weight: bold; color: var(--ink); border-bottom: 2px solid var(--accent-red); margin: 20px 0 35px 0; text-transform: uppercase; }
        .dossier-status { font-family: var(--font-en); font-size: 1.2rem; border: 3px solid #555; padding: 5px 15px; transform: rotate(-5deg); opacity: 0.4; margin-bottom: 15px; font-weight: bold; }
        .dossier-status.taken { border-color: var(--accent-red); color: var(--accent-red); opacity: 1; }

        .avatar-section { display: none; width: 100%; margin-top: 5px; animation: slideDown 0.5s ease; box-sizing: border-box; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; background: #fff; padding: 8px; border: 2px dashed #aaa; box-shadow: inset 0 0 5px rgba(0,0,0,0.1); width: 100%; box-sizing: border-box; margin-bottom: 10px; min-height: 180px; }
        .avatar-option { width: 100%; height: auto; aspect-ratio: 1 / 1; cursor: pointer; border: 2px solid transparent; padding: 2px; transition: 0.2s; opacity: 0.8; background: #fff; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .avatar-option:hover { opacity: 1; transform: scale(1.05); }
        .avatar-option.selected { border-color: var(--accent-red); opacity: 1; box-shadow: 0 0 5px rgba(138, 3, 3, 0.5); transform: scale(1.1) rotate(-2deg); z-index: 5; background: white; }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        .birthday-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: none;
            border-bottom: 2px solid var(--ink);
            background: transparent;
            font-family: var(--font-en);
            font-size: 1.2rem;
            text-align: center;
            color: var(--accent-red);
            font-weight: bold;
            letter-spacing: 2px;
        }
        .birthday-input:focus { outline: none; border-bottom-color: var(--accent-red); }

        .nav-btn { position: absolute; top: 25px; background: rgba(43, 29, 29, 0.8); color: #fff; border: none; width: 35px; height: 35px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; z-index: 50; display: flex; justify-content:center; align-items:center; transition: 0.2s; box-shadow: 0 4px 5px rgba(0,0,0,0.3); }
        .nav-btn:hover { background: var(--accent-red); transform: scale(1.1); } .nav-prev { left: 0; } .nav-next { right: 0; }

        /* --- æŒ‡ç´‹ --- */
        .fingerprint-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 60vh; width: 100%; cursor: pointer; margin-top: 20px; }
        .fingerprint { width: 140px; height: 180px; position: relative; display: flex; justify-content: center; align-items: center; }
        .fingerprint svg { fill: none; stroke: var(--accent-red); stroke-width: 2.5; stroke-linecap: round; width: 100%; height: 100%; filter: drop-shadow(0 0 2px rgba(138,3,3,0.5)); }
        .scan-line { position: absolute; width: 110%; height: 3px; background: var(--accent-red); box-shadow: 0 0 15px var(--accent-red); top: 0; animation: scan 1.8s infinite cubic-bezier(0.4, 0, 0.2, 1); left: -5%; }
        @keyframes scan { 0% { top: 0; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }

        /* --- ç‰¹å·¥æª”æ¡ˆ --- */
        .agent-dossier { width: 100%; background: #fdfbf7; border: 1px solid #999; padding: 15px; box-shadow: 5px 5px 10px rgba(0,0,0,0.2); font-family: var(--font-en); position: relative; margin-bottom: 20px; }
        .dossier-header { background: #111; color: #fff; padding: 10px; font-size: 1.5rem; letter-spacing: 2px; text-transform: uppercase; margin: -15px -15px 15px -15px; border-bottom: 2px solid #555; }
        .dossier-body { display: flex; gap: 10px; position: relative; }
        .dossier-info { flex: 1; display: flex; flex-direction: column; gap: 8px; font-size: 0.9rem; }
        .dossier-label { font-weight: bold; opacity: 0.6; font-size: 0.7rem; margin-bottom: -2px; }
        .dossier-value { border-bottom: 1px solid #aaa; padding-bottom: 2px; font-weight: bold; min-height: 20px; font-family: var(--font-cn); }
        .dossier-photo-frame { width: 110px; height: 130px; border: 4px solid #fff; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); background: #eee; position: relative; transform: rotate(2deg); }
        .dossier-photo-frame img { width: 100%; height: 100%; object-fit: cover; }
        
        /* ç”Ÿæ—¥å¸½æ¨£å¼ */
        .birthday-hat {
            position: absolute;
            top: -25px;
            right: -25px;
            font-size: 2.2rem;
            transform: rotate(15deg);
            z-index: 10;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3));
            animation: bounce 2s infinite;
            white-space: nowrap;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0) rotate(15deg); } 50% { transform: translateY(-5px) rotate(10deg); } }

        .rules-text { font-family: var(--font-cn); font-size: 0.9rem; line-height: 1.6; text-align: left; margin-top: 15px; color: #333; border-top: 1px dashed #aaa; padding-top: 10px; }
        .rules-text h4 { margin: 15px 0 5px 0; color: var(--accent-red); font-family: var(--font-hand); font-size: 1.6rem; font-weight: bold; }
        .rules-text ul { padding-left: 20px; margin: 5px 0; }
        .rules-text li { margin-bottom: 5px; }

        /* --- æ¡ˆä»¶å¤§å»³ --- */
        .btn-case { height: 90px; display:flex; flex-direction:column; justify-content:center; align-items:center; background: var(--ink); color: var(--paper); border: 2px solid var(--ink); width: 100%; margin: 10px 0; box-shadow: 4px 4px 0 rgba(0,0,0,0.2); cursor: pointer; position: relative; overflow: hidden; }
        .btn-case:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 rgba(0,0,0,0.2); }
        .progress-container { width: 100%; height: 6px; background: #555; position: absolute; bottom: 0; left: 0; }
        .progress-bar { height: 100%; background: var(--accent-red); width: 0%; transition: width 0.5s; }
        .blur-text { filter: blur(6px); user-select: none; transition: 0.3s; }
        .reveal-text { filter: blur(0); }

        /* --- ä»»å‹™ç¾å ´ --- */
        .mission-header-badge { background: #2b1d1d; color: #fff; padding: 10px 30px; font-size: 1.8rem; font-weight: bold; display: inline-block; transform: skew(-10deg); margin-bottom: 20px; box-shadow: 4px 4px 0 rgba(0,0,0,0.3); font-family: var(--font-cn); border-left: 5px solid var(--accent-red); }

        .scoreboard { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .score-circle { width: 60px; height: 60px; border-radius: 50%; border: 3px solid #555; background: #ddd; display: flex; justify-content: center; align-items: center; font-family: var(--font-en); font-weight: bold; font-size: 1.6rem; color: #333; position: relative; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .score-circle.success { background: var(--success-green); color: white; border-color: #1a3301; }
        .score-circle.fail { background: var(--fail-red); color: white; border-color: #330101; }
        .score-circle.current { background: #fff; color: var(--accent-red); animation: breathing-glow 2s infinite ease-in-out; transform: scale(1.1); z-index: 10; }
        @keyframes breathing-glow { 0% { box-shadow: 0 0 5px rgba(138, 3, 3, 0.2); border-color: #555; } 50% { box-shadow: 0 0 25px rgba(138, 3, 3, 0.8), inset 0 0 10px rgba(138, 3, 3, 0.1); border-color: var(--accent-red); } 100% { box-shadow: 0 0 5px rgba(138, 3, 3, 0.2); border-color: #555; } }
        .score-circle::after { content: attr(data-players); position: absolute; bottom: -25px; font-size: 0.8rem; color: #333; font-weight: bold; font-family: var(--font-cn); }

        .player-select-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; width: 100%; margin-top: 15px; }
        .player-tile { background: #fff; border: 2px solid #000; padding: 15px; text-align: center; cursor: pointer; position: relative; font-family: var(--font-en); font-weight: bold; font-size: 1.2rem; transition: 0.1s; box-shadow: 3px 3px 0 rgba(0,0,0,0.1); color: #000; }
        .player-tile:hover { transform: translate(-1px, -1px); box-shadow: 4px 4px 0 rgba(0,0,0,0.1); }
        .player-tile.selected { background: var(--ink); color: #fff; border-color: #000; box-shadow: none; transform: translate(2px, 2px); }
        
        #confirm-team-btn { width: 100%; background: #999; color: #fff; border: none; padding: 15px; font-size: 1.2rem; margin-top: 25px; cursor: pointer; font-family: var(--font-cn); font-weight: bold; box-shadow: none; }
        #confirm-team-btn:disabled { background: #ccc; cursor: not-allowed; }
        #confirm-team-btn:not(:disabled) { background: #555; }

        .vote-btn { width: 48%; padding: 15px; font-size: 1.2rem; border: 2px solid #000; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .vote-btn:active { transform: scale(0.95); opacity: 0.8; }
        .vote-btn.selected { border-color: white; box-shadow: 0 0 10px rgba(0,0,0,0.5); transform: scale(1.05); }
        .vote-success { background: var(--success-green); color: white; border-color: #1a3301; }
        .vote-fail { background: var(--fail-red); color: white; border-color: #330101; }

        /* --- ä»»å‹™å¡èˆ‡è¦å‰‡å¡ --- */
        .mission-card { background: #fff; border: 2px dashed #333; padding: 15px; margin-bottom: 20px; position: relative; text-align: left; }
        .mission-card h3 { margin-top: 0; color: var(--accent-red); font-family: var(--font-cn); border-bottom: 2px solid var(--ink); padding-bottom: 5px; }
        .secret-highlight { color: var(--accent-red); font-weight: bold; }

        /* --- ç¿»è½‰å¡ç‰‡æ¨£å¼ (ä¿®æ”¹: å„ªåŒ–æ‰‹æ©Ÿè§¸æ§èˆ‡æ»¾å‹•) --- */
        .flip-container { perspective: 1000px; width: 100%; height: 220px; cursor: pointer; margin-top: 15px; } 
        .flipper { transition: 0.6s; transform-style: preserve-3d; position: relative; width: 100%; height: 100%; }
        .flip-container.flipped .flipper { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { backface-visibility: hidden; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 2px dashed #555; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 15px; box-sizing: border-box; }
        .flip-card-front { z-index: 2; transform: rotateY(0deg); background: #eee; color: #555; font-weight: bold; text-align: center; }
        
        .flip-card-back { 
            transform: rotateY(180deg) translateZ(1px); 
            background: #fff; border-color: var(--accent-red); 
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            font-size: 0.95rem; line-height: 1.5; text-align: left; align-items: flex-start; 
        }

        .flip-container.flipped .flip-card-back {
            z-index: 10;
            pointer-events: auto;
        }
        
        .flip-card-back::-webkit-scrollbar { width: 12px; }
        .flip-card-back::-webkit-scrollbar-track { background: #e0e0e0; border-radius: 6px; }
        .flip-card-back::-webkit-scrollbar-thumb { background: var(--accent-red); border-radius: 6px; border: 2px solid #e0e0e0; }

        /* --- è¨ˆæ™‚å™¨ --- */
        #timer-display { font-family: var(--font-en); font-size: 4rem; text-align: center; margin: 20px 0; color: var(--ink); text-shadow: 2px 2px 0 rgba(0,0,0,0.2); font-weight: bold; }

        /* åŸå§‹å¹²æ“¾æ¨£å¼ï¼ˆä¿ç•™çµ¦å…¶ä»–åŠŸèƒ½ï¼‰ */
        .interference-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--accent-red); color: white; z-index: 999999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; animation: flash 0.5s infinite; display: none; cursor: pointer; }
        @keyframes flash { 0% { background: var(--accent-red); } 50% { background: #000; } 100% { background: var(--accent-red); } }
        
        /* éœæ…‹èƒŒæ™¯æ¨£å¼ (ç„¡é–ƒçˆ) çµ¦ç”Ÿæ—¥å½ˆçª— */
        .static-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); color: white; z-index: 999999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; display: none; cursor: default; }

        .number-btn { width: 50px; height: 50px; border: 2px solid var(--ink); display: flex; justify-content: center; align-items: center; font-size: 1.5rem; font-weight: bold; cursor: pointer; background: #fff; transition: 0.2s; }
        .number-btn.selected { background: var(--accent-red); color: white; border-radius: 50%; border-color: var(--accent-red); transform: scale(1.2); }
        .number-btn.disabled { opacity: 0.3; cursor: not-allowed; background: #ccc; border-color: #999; }

        .btn { background: var(--ink); color: var(--paper); border: 2px solid var(--ink); padding: 12px; font-family: var(--font-cn); font-size: 1.1rem; font-weight: bold; cursor: pointer; width: 100%; margin: 15px 0; letter-spacing: 1px; box-shadow: 3px 3px 0 rgba(138, 3, 3, 0.4); position: relative; }
        .btn:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0 rgba(138, 3, 3, 0.4); }
        .btn:disabled { background: #999; border-color: #999; color: #ccc; opacity: 0.8; box-shadow: none; cursor: not-allowed; }

        .btn-safe-bottom {
            margin-bottom: 60px !important;
        }
        
        .stamp-style { border: 4px solid currentColor; padding: 10px 20px; font-family: var(--font-cn); font-size: 1.8rem; font-weight: 900; display: inline-block; transform: rotate(-5deg); margin: 15px 0; background: rgba(255,255,255,0.5); letter-spacing: 5px; }
        .stamp-animate { animation: stamp-pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes stamp-pop { 0% { opacity: 0; transform: scale(3) rotate(15deg); } 100% { opacity: 1; transform: scale(1) rotate(-5deg); } }

        /* é‡ç½®æŒ‰éˆ•éš±è—æ¨£å¼ */
        .global-reset-btn { 
            position: fixed; top: 10px; right: 10px; 
            background: rgba(0,0,0,0.3); color: #666; 
            border: 1px solid #444; padding: 5px 10px; 
            font-size: 0.6rem; cursor: pointer; z-index: 99999; 
            transition: 0.3s;
        }
        .global-reset-btn:hover { background: var(--seal-red); color: white; border-color: white; }

        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg-blood); z-index: 9999; display: flex; justify-content:center; align-items:center; flex-direction: column; color: var(--paper); font-family: var(--font-en); }
        
        #assassin-grid .player-tile { background: #1a0000; border: 2px solid #500; color: #a00; font-family: var(--font-en); letter-spacing: 1px; }
        #assassin-grid .player-tile.selected { background: #500; color: white; border-color: red; box-shadow: 0 0 15px red; transform: scale(1.05); }

        /* æ‡²ç½°èˆ‡çå‹µæ–‡å­—æ¨£å¼ */
        .punishment-box { border: 2px solid var(--ink); padding: 15px; margin-top: 15px; background-color: rgba(255,255,255,0.5); }
        .special-reward { font-family: var(--font-cn); color: #fff; background: var(--seal-red); padding: 5px 10px; border-radius: 5px; display: inline-block; margin-top: 10px; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); animation: breathing-glow 2s infinite; }

        /* Emoji è£é£¾é¸æ“‡æ¬„æ¨£å¼ */
        .emoji-scroll-wrapper {
            display: flex; gap: 10px; overflow-x: auto; padding: 10px;
            background: rgba(255,255,255,0.5); border: 2px dashed #aaa;
            margin-top: 10px; scrollbar-width: none;
        }
        .emoji-scroll-wrapper::-webkit-scrollbar { display: none; }
        .emoji-btn {
            font-size: 2rem; cursor: pointer; padding: 5px; border-radius: 5px;
            background: transparent; border: none; transition: 0.2s;
            min-width: 50px; text-align: center;
        }
        .emoji-btn:hover { background: rgba(0,0,0,0.1); transform: scale(1.2); }
        
        /* æ¡ˆä»¶å¤§å»³é ­åƒ Wrapper */
        .lobby-avatar-wrapper {
            position: relative; width: 70px; height: 70px;
        }
        .lobby-emoji-badge {
            position: absolute; bottom: -5px; right: -5px;
            font-size: 1.8rem; text-shadow: 2px 2px 0 #fff;
            animation: bounce 2s infinite;
        }

        /* --- æ–°å¢è¨­è¨ˆï¼šæ¨ç†ç­†è¨˜æœ¬æ¨£å¼ --- */
        .notebook-trigger {
            position: fixed; bottom: 20px; right: 20px;
            width: 60px; height: 60px; border-radius: 50%;
            background: var(--ink); color: var(--paper);
            font-size: 1.5rem; border: 2px solid #fff;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            z-index: 9000; cursor: pointer;
            display: none; /* é è¨­éš±è—ï¼Œç™»å…¥å¾Œé¡¯ç¤º */
            justify-content: center; align-items: center;
            transition: 0.3s;
        }
        .notebook-trigger:hover { transform: scale(1.1); background: var(--accent-red); }
        
        .notebook-paper {
            background: #fff; width: 90%; max-width: 400px;
            padding: 20px; border: 2px solid #333;
            font-family: var(--font-cn); color: #333;
            max-height: 80vh; overflow-y: auto;
            background-image: linear-gradient(#e1e1e1 1px, transparent 1px);
            background-size: 100% 1.5rem;
            line-height: 1.5rem;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
            transform: rotate(1deg);
        }
        .note-row {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #ccc; padding: 10px 0;
        }
        .note-name { font-weight: bold; font-family: var(--font-en); font-size: 1.1rem; }
        .note-status-btn {
            background: #eee; border: 1px solid #999;
            padding: 5px 0; cursor: pointer; font-size: 0.9rem;
            width: 90px; text-align: center; border-radius: 5px;
            transition: 0.2s;
        }
        .note-memo-area {
            width: 100%; margin-top: 15px; height: 80px;
            border: 1px dashed #999; padding: 10px;
            font-family: var(--font-cn); font-size: 1rem;
            background: rgba(255,255,255,0.5);
        }

        /* --- ä¿®æ”¹ Task 1: ç”Ÿæ—¥å½ˆçª—å„ªåŒ–æ¨£å¼ (ç¸®å°) --- */
        #birthday-modal > div {
            width: 85%; /* ç¸®å°ä¸€é» */
            max-width: 350px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
            padding: 25px; /* æ¸›å°‘å…§é‚Šè· */
            background: #f2e8d5; /* ç¢ºä¿ä¸é€æ˜èƒŒæ™¯ */
            border: 3px solid var(--accent-red);
            transform: rotate(-2deg);
            box-shadow: 0 0 50px rgba(0,0,0,0.9);
            position: relative;
            z-index: 200000; /* ç¢ºä¿å±¤ç´šæœ€é«˜ */
        }
        
        /* --- æ‡²ç½°è½‰ç›¤æ¨£å¼ --- */
        .roulette-container {
            width: 100%;
            margin-top: 20px;
            text-align: center;
        }
        .roulette-box {
            border: 4px solid var(--ink);
            background: #fff;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--accent-red);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
            overflow: hidden;
            position: relative;
        }
        .roulette-option {
            animation: none;
        }
        .special-card-display {
            background: linear-gradient(135deg, #2b1d1d, #8a0303);
            color: #fff;
            padding: 15px;
            border: 2px solid #d4af37;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
            margin-bottom: 20px;
            transform: rotate(-1deg);
        }
/* --- æ–°å¢ï¼šæ‡¸æµ®æŒ‰éˆ•çµ„æ¨£å¼ --- */
        .fab-group {
            position: fixed; 
            bottom: 90px; /* ä½æ–¼ç­†è¨˜æŒ‰éˆ• (bottom:20px) çš„ä¸Šæ–¹ */
            right: 20px;
            display: flex; flex-direction: column; gap: 15px;
            z-index: 9000; 
            pointer-events: none; /* å®¹å™¨ä¸æ“‹é»æ“Š */
        }
        .fab-btn {
            width: 50px; height: 50px; border-radius: 50%;
            border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            cursor: pointer; pointer-events: auto;
            display: none; /* é è¨­éš±è—ï¼Œç™»å…¥å¾Œé¡¯ç¤º */
            justify-content: center; align-items: center;
            background-size: cover; background-position: center;
            transition: transform 0.2s;
        }
        .fab-btn:active { transform: scale(0.9); }
        
        /* æ¡ˆä»¶å¤§å»³æŒ‰éˆ• (æ”¾å¤§é¡) */
        #fab-lobby { background-color: var(--accent-red); font-size: 1.5rem; color: #fff; }
        
        /* äººç‰©åœ–åƒæŒ‰éˆ• (èƒŒæ™¯åœ–ç”± JS å‹•æ…‹è¼‰å…¥) */
        #fab-dossier { background-color: var(--ink); border: 2px solid var(--accent-red); }
    </style>
</head>
<body>

    <!-- éŸ³æ•ˆç´ æ -->
    <audio id="sfx-click">
        <source src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.m4a" type="audio/mp4">
    </audio>
    <audio id="sfx-alert">
        <!-- ç·Šå¼µè­¦å ±è² -->
        <source src="https://assets.mixkit.co/active_storage/sfx/995/995-preview.m4a" type="audio/mp4">
    </audio>

    <button class="global-reset-btn" onclick="hardReset()">âš  RESET</button>

    <div id="loading">
        <h2>DECRYPTING...</h2>
    </div>

    <!-- å…¨å±å¹²æ“¾å¡ (ä¿ç•™çµ¦æŠ½çç­‰ä½¿ç”¨) -->
    <div id="interference-fullscreen" class="interference-overlay" onclick="this.style.display='none'">
        <h1 style="font-size: 4rem; border: none; color: white;">âš  WARNING</h1>
        <h2 id="interference-text" style="background: none; box-shadow: none; font-size: 2rem;"></h2>
        <p style="margin-top:20px; font-size:1rem; opacity:0.8;">( TAP SCREEN TO DISMISS )</p>
    </div>

    <!-- Jasmineç”Ÿæ—¥å½ˆçª— (å·²ç¸®å°) -->
    <div id="birthday-modal" class="static-overlay">
         <div>
            <div style="position:absolute; top:-15px; left:50%; transform:translateX(-50%); background:var(--ink); color:var(--paper); padding:5px 15px; font-family:var(--font-en); font-size:0.8rem;">TOP SECRET</div>
            <h2 style="color: var(--accent-red); font-family: var(--font-en); border-bottom: 2px solid var(--ink); padding-bottom: 10px; margin-top: 10px;">MESSAGE DECODED</h2>
            <p style="font-family: var(--font-cn); font-size: 1.5rem; font-weight: bold; margin: 20px 0; line-height: 1.5;">ç¥ç©å®¶ Jasmine<br>ç”Ÿæ—¥å¿«æ¨‚ ğŸ‚</p>
            <p style="text-align: right; font-family: var(--font-en); margin-top: 20px; font-weight: bold;">â€”â€” By Skai</p>
            <button class="btn" onclick="closeBirthdayModal()" style="margin-top: 25px;">RECEIVED</button>
         </div>
    </div>

    <!-- æ–°å¢ï¼šç‰¹å·¥æ¨ç†ç­†è¨˜æ‡¸æµ®æŒ‰éˆ•èˆ‡å½ˆçª— -->
    <button id="notebook-btn" class="notebook-trigger" onclick="toggleNotebook()">ğŸ“</button>

    <div id="notebook-modal" class="static-overlay" style="display:none; z-index: 200000; background: rgba(0,0,0,0.7);">
        <div class="notebook-paper">
            <h3 style="border-bottom: 2px solid #333; padding-bottom: 10px; margin-top: 0;">ğŸ•µï¸ ç‰¹å·¥æ¨ç†ç­†è¨˜ <br><small style="font-size:0.7rem; color:#666;">(åƒ…è‡ªå·±å¯è¦‹ / Local Storage)</small></h3>
            <div id="notebook-entries"></div>
            <textarea id="notebook-memo" class="note-memo-area" placeholder="è‡ªç”±å‚™å¿˜éŒ„ï¼šè¨˜éŒ„èª°èªªäº†è¬Š..."></textarea>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn" onclick="saveNotebook()" style="background:var(--success-green); border:none; padding: 5px;">ä¿å­˜ (SAVE)</button>
                <button class="btn" onclick="toggleNotebook()" style="background:#666; border:none; padding: 5px;">é—œé–‰ (CLOSE)</button>
            </div>
        </div>
    </div>
<!-- æ–°å¢ï¼šæ‡¸æµ®æŒ‰éˆ•çµ„ (äººç‰©é ­åƒ + æ”¾å¤§é¡) -->
    <div class="fab-group">
        <!-- äººç‰©åœ–åƒæŒ‰éˆ•ï¼šé»æ“Šå»æª”æ¡ˆé  -->
        <div id="fab-dossier" class="fab-btn" onclick="showGlobalPage('dossier')"></div>
        <!-- æ¡ˆä»¶å¤§å»³æŒ‰éˆ•ï¼šé»æ“Šå»å¤§å»³ -->
        <div id="fab-lobby" class="fab-btn" onclick="enterLobby()">ğŸ”</div>
    </div>
    <div class="container">
        <!-- Page 0: Cover -->
        <div id="page-0" class="page active">
            <div class="magnifying-glass"></div>
            <div class="scattered-paper" style="top: 10%; left: 5%; transform: rotate(-10deg);">CONFIDENTIAL</div>
            <div class="scattered-paper" style="top: 15%; right: 5%; transform: rotate(5deg);">EVIDENCE #01</div>
            <div class="scattered-paper" style="bottom: 20%; left: 10%; transform: rotate(15deg);">SUSPECT LIST</div>

            <div style="margin-top: 80px; text-align: center; position: relative; z-index: 2;">
                <h1 style="margin-top:20px; color: #111; text-shadow: 2px 2px 0px rgba(138, 3, 3, 0.2);">è–èª•å¤šçŒœå¿Œ</h1>
                <p style="font-family: var(--font-en); font-size: 1.2rem; color: var(--accent-red); letter-spacing: 2px;">AVALON PROTOCOL</p>
            </div>
            <div style="flex-grow: 1;"></div>
            <button class="btn btn-safe-bottom" style="z-index: 2;" onclick="startGameWithInstructions()">é–‹å§‹èª¿æŸ¥ (START)</button>
        </div>

        <!-- Page 1: Login -->
        <div id="page-1" class="page">
            <h2>æ¢å“¡å ±åˆ°</h2>
            <div class="file-viewer-wrapper">
                <div class="dossier-folder">
                    <button class="nav-btn nav-prev" onclick="changeFile(-1)" style="top: 20px; left: -20px;">&#8249;</button>
                    <button class="nav-btn nav-next" onclick="changeFile(1)" style="top: 20px; right: -20px;">&#8250;</button>
                    <div style="font-size: 2rem; opacity: 0.2; position: absolute; top: 10px; right: 20px;">#<span id="file-number">01</span></div>
                    <div style="text-align: center; width: 100%;">
                        <div style="font-size: 0.8rem; color: #666; margin-top: 10px;">CODE NAME</div>
                        <div id="file-name" class="dossier-name">SKAI</div>
                        <div id="file-status" class="dossier-status">AVAILABLE</div>
                    </div>
                    <button id="select-name-btn" class="btn" style="background: white; color: var(--ink); border: 1px dashed var(--ink);" onclick="openFileAvatarSection()">é–‹å•Ÿæª”æ¡ˆ (SELECT)</button>
                    <div id="avatar-section" class="avatar-section">
                        <div style="font-size: 0.8rem; color: #666; margin: 10px 0; text-align: center;">ATTACH PHOTO ID:</div>
                        <div id="avatar-selection-grid" class="avatar-grid"></div>
                        
                        <div style="margin-top: 10px; text-align: center;">
                            <input type="tel" id="birthday-input" class="birthday-input" placeholder="è¼¸å…¥ç”Ÿæ—¥ (4ä½æ•¸)" maxlength="4">
                        </div>

                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <button class="btn" style="background: #ccc; border:none; font-size: 0.8rem; padding: 5px; flex:1;" onclick="closeFileAvatarSection()">å–æ¶ˆ</button>
                            <button id="confirm-btn" class="btn" style="margin:0; flex:2; background: var(--accent-red); border-color: var(--accent-red);" onclick="confirmIdentity()" disabled>ç¢ºèª (CONFIRM)</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 1.5: Fingerprint Unlock -->
        <div id="page-fingerprint" class="page">
            <h2>èº«ä»½é©—è­‰</h2>
            <div class="fingerprint-container" onclick="unlockDossier()">
                <div class="fingerprint">
                    <svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
                        <path d="M50 10 C 20 10 10 35 10 60 C 10 85 20 110 50 110 C 80 110 90 85 90 60 C 90 35 80 10 50 10 M 50 20 C 30 20 20 40 20 60 M 50 20 C 70 20 80 40 80 60 M 30 60 C 30 80 40 90 50 90 C 60 90 70 80 70 60 M 40 60 C 40 70 45 75 50 75 C 55 75 60 70 60 60" fill="none" stroke="var(--accent-red)" stroke-width="2" />
                    </svg>
                    <div class="scan-line"></div>
                </div>
                <p style="margin-top: 20px; color: var(--accent-red); font-family: var(--font-en); animation: pulse 1s infinite;">TOUCH TO DECRYPT</p>
            </div>
        </div>

        <!-- Page 1.6: Dossier Reveal -->
        <div id="page-dossier" class="page">
            <div class="agent-dossier">
                <div class="dossier-header">SECRET AGENT</div>
                <div class="dossier-body">
                    <div class="dossier-info">
                        <span class="dossier-label">CODE NAME:</span>
                        <div class="dossier-value" id="dossier-codename"></div>
                        
                        <span class="dossier-label">BIRTHDAY:</span>
                        <div class="dossier-value" id="dossier-birthday" style="font-size:0.9rem;"></div>

                        <span class="dossier-label">ROLE:</span>
                        <div class="dossier-value" id="dossier-role" style="color:var(--accent-red)"></div>
                        
                        <span class="dossier-label">OBJECTIVE:</span>
                        <div class="dossier-value" id="dossier-objective" style="font-size:0.8rem; font-weight:normal;"></div>
                    </div>
                    <div class="dossier-photo-frame">
                        <div id="birthday-hat-container"></div>
                        <img id="dossier-photo" src="">
                    </div>
                </div>
                
                <p style="text-align:left; margin-top:10px; font-size:0.8rem; opacity:0.7;">IDENTITY VERIFIED:</p>
                <div style="text-align:center;">
                    <div id="dossier-role-stamp" class="stamp-style" style="border: 2px solid var(--ink); padding: 5px;"></div>
                </div>

                <div id="dossier-teammates" style="font-size: 0.8rem; color: var(--accent-red); margin-top: 10px; background: #eee; padding: 5px; font-weight: bold; border-left: 3px solid var(--accent-red);"></div>

                <div class="rules-text">
                    <h4>MISSION PROTOCOL</h4>
                    <p style="font-weight:bold;">ç’°ç¯€ä¸€ï¼šæº–å‚™æ´¾å°ï¼ˆè©³è¦‹æ¡ˆä»¶æª”æ¡ˆä¸€ï¼‰</p>
                    <ul>
                        <li>ä»»å‹™ä¸€ï¼šæº–å‚™è£é£¾ç‰©</li>
                        <li>ä»»å‹™äºŒï¼šæº–å‚™æ€ªç¦®ç‰©</li>
                    </ul>
                    <p style="font-weight:bold; margin-top:10px;">ç’°ç¯€äºŒï¼šæ´¾å°è¡Œå‹• (é—œéµ)</p>
                    <ul>
                        <li>éŠæˆ²å…± 3 è¼ªä»»å‹™</li>
                        <li>é ˜è¢–æ“æœ‰çµ•å°è©±èªæ¬Šï¼Œå¯æŒ‡å®šè¡Œå‹•ç´°ç¯€</li>
                        <li><strong>è‡¥åº•ç›®æ¨™ï¼š</strong>å°è‡´ 2 æ¬¡ä»»å‹™å¤±æ•— -> ç›´æ¥ç²å‹</li>
                        <li><strong>åµæ¢ç›®æ¨™ï¼š</strong>å–å¾— 2 æ¬¡ä»»å‹™æˆåŠŸ</li>
                    </ul>
                </div>
            </div>
            <button class="btn btn-safe-bottom" onclick="enterLobby()">å‰å¾€æ¡ˆä»¶å¤§å»³ (PROCEED)</button>
        </div>

        <!-- Page 2: Lobby -->
        <div id="page-2" class="page">
            <button style="position: absolute; top: 15px; left: 15px; background:transparent; border:none; color:var(--ink); cursor:pointer; font-weight:bold;" onclick="showGlobalPage('dossier')">â† æŸ¥çœ‹ç‰¹å·¥æª”æ¡ˆ</button>
            
            <h2>æ¡ˆä»¶å¤§å»³</h2>
            <div class="case-file" style="display:flex; align-items:center; gap: 15px;">
                <div class="lobby-avatar-wrapper">
                    <img id="lobby-avatar-img" src="" style="width: 100%; height: 100%; border-radius: 10px; border: 2px solid var(--ink); object-fit: cover;">
                    <div id="lobby-emoji-display" class="lobby-emoji-badge"></div>
                </div>
                <div style="text-align:left;">
                    <span style="font-size:0.8rem; color:#888;">AGENT IDENTITY</span><br>
                    <span id="lobby-player-name" style="font-weight:bold; font-size: 1.5rem; color:var(--accent-red)"></span>
                    <div style="display:flex; align-items:center; gap:10px; margin-top:5px;">
                        <span id="lobby-player-role" class="blur-text" style="font-weight:bold; font-size: 1rem; color:#555;">[ Loading... ]</span>
                        <button onclick="toggleRoleVisibility()" style="border:none; background:none; cursor:pointer; font-size:1.2rem;">ğŸ‘ï¸</button>
                    </div>
                </div>
            </div>
            
            <div class="btn-case" onclick="showLocalPage(3)">
                <span style="font-size: 1.2rem; font-weight:bold;">ğŸ“ æ¡ˆä»¶ä¸€ï¼šæº–å‚™æ´¾å°</span>
                <span style="font-size: 0.8rem; opacity:0.8;">è£é£¾æŒ‡ä»¤ / æŠ½å–æ€ªç¦®ç‰©</span>
            </div>

            <div class="btn-case" onclick="enterMainGame()">
                <span style="font-size: 1.2rem; font-weight:bold;">ğŸ“ æ¡ˆä»¶äºŒï¼šæ´¾å°è¡Œå‹•</span>
                <span style="font-size: 0.8rem; opacity:0.8;">æŒ‡èªè‡¥åº• / åŸ·è¡Œä»»å‹™</span>
                <div class="progress-container"><div class="progress-bar" id="lobby-progress"></div></div>
            </div>

            <!-- Emoji è£é£¾é¸æ“‡æ¬„ -->
            <div style="width: 100%; margin-top: 20px; text-align: left;">
                <p style="font-size: 0.8rem; color: #666; font-weight: bold; margin-left: 5px;">å€‹äººå½¢è±¡è£é£¾ (DECORATION)</p>
                <div id="emoji-selector" class="emoji-scroll-wrapper"></div>
            </div>
        </div>

        <!-- Page 3: Prep -->
        <div id="page-3" class="page">
            <button style="position: absolute; top: 15px; left: 15px; background:transparent; border:none; color:var(--ink); cursor:pointer; font-weight:bold;" onclick="showLocalPage(2)">â† BACK</button>
            <h2>æ¡ˆä»¶ä¸€ï¼šæº–å‚™æ´¾å°</h2>
            
            <div class="case-file">
                <p style="text-align:left; font-weight:bold; border-bottom:1px solid #ccc;">ä»»å‹™ä¸€ï¼šæ´¾å°è£é£¾</p>
                <p id="mission-deco-text" style="margin: 15px 0; font-size: 1.1rem;">è®€å–æŒ‡ä»¤ä¸­...</p>
                
                <p style="text-align:left; font-weight:bold; border-bottom:1px solid #ccc; margin-top:20px;">ä»»å‹™äºŒï¼šæ€ªç¦®ç‰©</p>
                <div style="text-align:center; margin: 15px 0;">
                    <div id="gift-rule-btn" onclick="revealRule()" style="border: 2px dashed #888; padding: 10px; cursor: pointer; color: #666;">é»æ“ŠæŠ½å–è¦å‰‡</div>
                    <div id="gift-rule-display" style="display:none;">
                        <div id="gift-rule-text" class="stamp-style" style="border-style: dashed; font-size: 1.2rem; transform: rotate(1deg);"></div>
                        <p id="gift-rule-desc" style="font-size: 0.9rem; margin-top: 5px; font-weight: bold; color: var(--accent-red);"></p>
                        <p style="font-size: 0.8rem; color: #666;">(é ç®— $50)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page 4: Avalon Game -->
        <div id="page-4" class="page">
            <button style="position: absolute; top: 15px; left: 15px; background:transparent; border:none; color:var(--ink); cursor:pointer; font-weight:bold;" onclick="showLocalPage(2)">â† BACK</button>
            
            <div class="mission-header-badge">
                ä»»å‹™ç¾å ´ <span style="color:var(--accent-red); margin-left:5px;" id="round-indicator">ROUND 1 / 3</span>
            </div>

            <div class="scoreboard">
                <div id="game-score-1" class="score-circle" data-players="3äºº">1</div>
                <div id="game-score-2" class="score-circle" data-players="3äºº">2</div>
                <div id="game-score-3" class="score-circle" data-players="4äºº">3</div>
            </div>
            
            <!-- Phase 1: Intro (å ´æ¬¡ä»‹ç´¹) -->
            <div id="phase-round-intro" style="display:none; width: 100%; text-align: center;">
                <h1 id="intro-title" style="font-size: 1.8rem; border-bottom: 2px solid var(--accent-red); margin-bottom: 20px;"></h1>
                <p style="font-size: 1.2rem; margin: 20px 0;">ç•¶å‰é ˜è¢– : <strong id="intro-leader-name" style="color: var(--accent-red);"></strong></p>
                <button class="btn" onclick="startRoundRules()" style="background: var(--accent-red); margin-top:30px;">é–‹å§‹ä»»å‹™ (START MISSION)</button>
            </div>

            <!-- Phase 2: Rules (æœ¬å ´æ¬¡è¦å‰‡) -->
            <div id="phase-rules" style="display:none; width: 100%; text-align: center;">
                <div class="mission-card">
                    <h3>æœ¬è¼ªæŒ‡ä»¤ (CLASSIFIED)</h3>
                    <div id="rules-public-display" style="margin-bottom: 10px; font-weight: bold; font-size: 0.9rem; white-space: pre-line;"></div>
                    
                    <!-- ç¿»è½‰å¡ç‰‡è¨­è¨ˆ -->
                    <div class="flip-container" onclick="this.classList.toggle('flipped')">
                        <div class="flipper">
                            <div class="flip-card-front">
                                <span style="font-size:2rem; margin-bottom:10px;">ğŸ”’</span>
                                ä½ çš„ç§˜å¯†ä»»å‹™<br><small>(é»æ“Šç¿»é–±)</small>
                            </div>
                            <div class="flip-card-back" id="rules-secret-display">
                                <!-- ç§˜å¯†ä»»å‹™å…§å®¹ -->
                            </div>
                        </div>
                    </div>

                </div>
                <div id="leader-start-discussion-btn" style="display:none;">
                    <button class="btn" style="background: var(--ink); color: white;" onclick="startRoundDiscussion()">é€²å…¥è¨è«– (ENTER DISCUSSION)</button>
                    <p style="font-size:0.8rem; color:#666;">(åƒ…é ˜è¢–å¯é»æ“Š)</p>
                </div>
                <div id="member-waiting-rules" style="text-align: center; color: #666; font-style: italic; margin-top: 20px;">
                    ç­‰å¾…é ˜è¢–é–‹å•Ÿè¨è«–...
                </div>
            </div>

            <!-- Phase 3: Discussion (å€’è¨ˆæ™‚) -->
            <div id="phase-discussion" style="display:none; width: 100%; text-align: center;">
                <div style="background: rgba(0,0,0,0.05); padding: 20px; border: 2px solid var(--ink); margin-top: 20px;">
                    <h3>è¨è«–ç’°ç¯€</h3>
                    <p style="font-size: 0.9rem;">è«‹è§€å¯Ÿå°è©±ä¸­çš„é—œéµè©èˆ‡å‹•ä½œã€‚</p>
                    <div id="timer-display">03:00</div>
                    
                    <!-- è¨è«–éšæ®µä¹Ÿé¡¯ç¤ºç§˜å¯†ä»»å‹™ (ç¿»è½‰å¡ç‰‡) -->
                    <div class="flip-container" onclick="this.classList.toggle('flipped')" style="height:120px;">
                        <div class="flipper">
                            <div class="flip-card-front" style="background:#fff; border:1px solid #ccc;">
                                <small>å†æ¬¡æŸ¥çœ‹ç§˜å¯†ä»»å‹™</small>
                            </div>
                            <div class="flip-card-back" id="rules-secret-display-discussion"></div>
                        </div>
                    </div>
                </div>
                <button class="btn" style="background: var(--ink); color: white; margin-top: 20px;" onclick="startAssignmentPhase()">å¿«é€Ÿé€²å…¥æŒ‡æ´¾ (SKIP)</button>
            </div>

            <!-- Phase 4: Assignment (é ˜è¢–æŒ‡æ´¾) -->
            <div id="phase-assignment" style="display:none; width: 100%; text-align: center;">
                <div id="leader-controls" style="display:none; width: 100%;">
                    <p>è«‹é ˜è¢–æ ¹æ“šè¨è«–çµæœæŒ‡æ´¾ç‰¹å·¥ï¼š</p>
                    <div id="team-select-grid" class="player-select-grid"></div>
                    <button id="confirm-team-btn" onclick="confirmAssignment()" disabled>ç¢ºèªæŒ‡æ´¾ (CONFIRM)</button>
                </div>
                <div id="member-waiting-assignment" style="text-align: center; color: #666; font-style: italic; margin-top: 20px;">
                    ç­‰å¾…é ˜è¢–æŒ‡æ´¾äººé¸...
                </div>
            </div>

            <!-- Phase 5: Mission Voting -->
            <div id="phase-mission" style="display:none; width: 100%;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3>è¡Œå‹•åŸ·è¡Œä¸­</h3>
                    <p>æŒ‡æ´¾æˆå“¡ï¼š<br><span id="mission-team-names" style="font-weight:bold; font-size: 1.2rem;"></span></p>
                </div>
                <div id="voting-area" style="display:none; margin-top: 20px;">
                    <p style="color: var(--accent-red); text-align: center;">è«‹æäº¤ä½ çš„è¡Œå‹•å ±å‘Š</p>
                    <div style="display:flex; justify-content:space-between; gap: 10px;">
                        <button id="vote-btn-success" class="vote-btn vote-success" onclick="submitMissionVote(true)">ä»»å‹™æˆåŠŸ</button>
                        <button id="vote-btn-fail" class="vote-btn vote-fail" onclick="submitMissionVote(false)">ä»»å‹™å¤±æ•—</button>
                    </div>
                    <p id="good-guy-warning" style="font-size: 0.7rem; color: #666; display:none; margin-top:5px; text-align: center;">*åµæ¢åªèƒ½æŠ•æˆåŠŸ</p>
                </div>
                <div id="voting-wait" style="text-align: center; color: #666; margin-top: 20px;">ç­‰å¾…æˆå“¡æäº¤å ±å‘Š...</div>
            </div>

            <!-- Phase 6: Result -->
            <div id="phase-result" style="display:none; width: 100%; text-align: center;">
                <div style="border: 2px solid var(--ink); padding: 20px; background: #fff; margin-top: 20px;">
                    <h3>ä»»å‹™çµæœ</h3>
                    <h1 id="round-result-text" style="border:none; margin: 10px 0;"></h1>
                    <div id="vote-reveal" style="display:flex; justify-content:center; gap:10px; margin-top:10px;"></div>
                </div>
                <button class="btn" onclick="nextRound()" id="next-round-btn" style="display:none; margin-top: 20px;">ä¸‹ä¸€è¼ª (Next)</button>
                <div id="waiting-host-msg" style="text-align:center; font-size:0.8rem; margin-top: 10px;">ç­‰å¾…ä¸»æŒäººé€²å…¥ä¸‹ä¸€è¼ª...</div>
            </div>
        </div>

        <!-- Page 5: Assassin -->
        <div id="page-5" class="page" style="background-color: #000; color: #fff;">
             <!-- Placeholder -->
        </div>

        <!-- Page 6: Final -->
        <div id="page-6" class="page">
            <h2>æœ€çµ‚çµå±€</h2>
            <div class="case-file">
                <h1 id="final-winner" style="color: var(--accent-red); border:none;"></h1>
                <p id="final-reason"></p>
                <hr style="border-top: 1px dashed #000;">
                <div id="final-roles-reveal" style="text-align: left; font-size: 0.9rem;"></div>
            </div>
            <!-- ä¿®æ”¹ Task 3: æŒ‰éˆ•å°å‘æ‡²ç½°é é¢ -->
            <button class="btn btn-safe-bottom" onclick="enterPunishmentPhase()">å‰å¾€æ‡²ç½°ç’°ç¯€ (PUNISHMENT)</button>
        </div>

        <!-- æ–°å¢ Task 3: Page 6.5 Punishment -->
        <div id="page-punishment" class="page">
            <h2>æ‡²ç½°è½‰ç›¤</h2>
            <p id="punishment-instruction"></p>
            
            <div id="punishment-input-area" style="display:none; width:100%;">
                <input type="text" id="punishment-input-one" class="birthday-input" placeholder="è¼¸å…¥ä¸€å€‹æ‡²ç½°..." style="text-align:left;">
                <button class="btn" onclick="submitOnePunishment()">æäº¤æ‡²ç½° (SUBMIT)</button>
            </div>

            <div id="punishment-wait-area" style="display:none; text-align:center; color:#666;">
                <p>ç­‰å¾…æ‰€æœ‰ç²å‹è€…è¼¸å…¥æ‡²ç½°...</p>
                <p id="punishment-status-count" style="font-weight:bold; color:var(--accent-red); margin-top:5px;"></p>
            </div>

            <div id="punishment-wheel-area" style="display:none; width:100%; text-align:center;">
                <div class="roulette-container">
                    <div class="roulette-box">
                        <div id="roulette-display">?</div>
                    </div>
                </div>
                <button id="spin-btn" class="btn" style="background:var(--accent-red); border-color:var(--accent-red);" onclick="spinPunishmentWheel()">é–‹å§‹è½‰ç›¤ (SPIN)</button>
            </div>

            <div style="flex-grow:1;"></div>
           <button id="btn-go-gift" class="btn btn-safe-bottom" onclick="attemptFinishPunishment()" disabled style="opacity: 0.5;">ç­‰å¾…æ‡²ç½°æäº¤... (LOCKED)</button>
        </div>

        <!-- Page 7: Gift (ä¿®æ”¹: é¡¯ç¤ºå„ªå…ˆæŠ½çè€…èˆ‡äº¤æ›å¡) -->
        <div id="page-7" class="page">
            <h2>æ²’äººæƒ³è¦ä½ çš„ç¦®ç‰©ï¼ˆæ€ªç¦®ç‰©ï¼‰äº¤æ›</h2>
            
            <!-- æ–°å¢: è¼ªæ¬¡èˆ‡MVPå¡ç‰‡å€åŸŸ -->
            <div id="gift-priority-display" style="width:100%; text-align:center; padding:10px; border-bottom:2px dashed #aaa; margin-bottom:15px;">
                <!-- JS å¡«å…… -->
            </div>

            <p>è«‹é¸æ“‡æ‚¨å¸¶ä¾†çš„ç¦®ç‰©è™Ÿç¢¼</p>
            <div id="my-gift-select" style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-bottom: 20px;"></div>
            <div id="draw-section" style="width: 100%; text-align: center; display:none;">
                <button id="btn-draw-gift" class="btn" style="background: var(--accent-red); border-color: var(--accent-red);" onclick="luckyDraw()">é–‹å§‹æŠ½ç</button>
            </div>
            <div id="draw-result" style="margin-top: 20px; width: 100%;"></div>
        </div>
<!-- æ–°å¢ Page 8: çµå±€æ’’èŠ±é  -->
        <div id="page-8" class="page">
            <div style="flex-grow:1; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <h1 style="color: var(--accent-red); font-size: 3rem; margin-bottom: 20px;">ğŸ‰ éŠæˆ²çµæŸ ğŸ‰</h1>
                <h2 style="background: none; color: #333; box-shadow: none;">æ’’èŠ±ï¼</h2>
                <div style="font-size: 5rem; animation: bounce 2s infinite;">ğŸ’ğŸš€âœ¨</div>
                <button class="btn" style="margin-top: 40px;" onclick="alert('æ¢éšªåŠŸèƒ½é–‹ç™¼ä¸­ / æˆ–æ˜¯è«‹è‡ªè¡Œå®‰æ’å¾ŒçºŒæ´»å‹•ï¼')">å‰å¾€æ¢éšª (EXPLORE)</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAtFUh2OUigNcuxU4p3qFUPdq6RM-hLnQ4",
            authDomain: "christmas-game-81e58.firebaseapp.com",
            databaseURL: "https://christmas-game-81e58-default-rtdb.firebaseio.com",
            projectId: "christmas-game-81e58",
            storageBucket: "christmas-game-81e58.firebasestorage.app",
            messagingSenderId: "76914667234",
            appId: "1:76914667234:web:a03080c958af3a0fab38bb"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const PLAYERS_LIST = ["Skai", "Joyce", "Katie", "Jasmine", "Macy", "Ching", "Bowie", "Carman"];
        
        // ç”Ÿæ—¥è³‡æ–™
        const BIRTHDAYS = {
            "Skai": "0426",
            "Jasmine": "1216",
            "Macy": "1113",
            "Katie": "0428",
            "Joyce": "0703",
            "Carman": "0817",
            "Ching": "0920",
            "Bowie": "0905"
        };

        // Emoji åˆ—è¡¨
        const EMOJI_OPTIONS = ["ğŸ…", "ğŸ¤¶", "ğŸ„", "ğŸ", "â­", "â˜ƒï¸", "â„ï¸", "ğŸ¦Œ", "ğŸ€ ", "ğŸ”", "âœ¨", "ğŸ˜", "ğŸ•µï¸", "ğŸ‘‘", "ğŸ˜ˆ", "ğŸ”¦ ", "ğŸ‰", "ğŸ”¥", "ğŸ””", "ğŸ‘»"];

        const GIFT_RULES = ["å¤–è²Œå¤æ€ª", "ç”¨é€”å¤æ€ª", "æ•´é«”è©­ç•°"];
        const GIFT_DESCRIPTIONS = {
            "å¤–è²Œå¤æ€ª": "è®“äººçœ‹ç¬¬ä¸€çœ¼å°±æƒ³ç§»é–‹è¦–ç·šã€‚",
            "ç”¨é€”å¤æ€ª": "çŸ¥é“æ€éº¼ç”¨ï¼Œä½†ä¸çŸ¥é“ç‚ºä»€éº¼è¦ç”¨ã€‚",
            "æ•´é«”è©­ç•°": "æ•£ç™¼è‘—ä¸€è‚¡ä¸å±¬æ–¼é€™å€‹æ¬¡å…ƒçš„æ°£æ¯ã€‚"
        };
        const AVATAR_SEEDS = ["Felix", "Aneka", "Snuggles", "Midnight", "Cuddles", "Shadow", "Ginger", "Boots"];
        const ROUND_CONFIG = [3, 3, 4];
        const GAME_SCENARIOS = {
            1: {
                title: "ç¬¬ä¸€è¼ªï¼šæ¡è³¼é£Ÿæèˆ‡è£é£¾ (3äººåŸ·è¡Œ)",
                leader_rule: "ã€é›™ç·šä½œæˆ°æŒ‡æ®ä»¤ã€‘\næœ¬è¼ªåˆ†ç‚º[æ¡è³¼çµ„]èˆ‡[è£é£¾çµ„]ã€‚é ˜è¢–éœ€æ±ºå®šè¦ªè‡ªå¸¶é ˜å“ªä¸€çµ„ï¼Œä¸¦ä»»å‘½ä¸€åå‰¯é ˜è¢–å¸¶é ˜å¦å¤–ä¸€çµ„ã€‚\né ˜è¢–å€‘éœ€è¦èªªå‡ºé—œéµè©ï¼Œè§€å¯Ÿè‡¥åº•æ˜¯èª°ã€‚\næ¡è³¼çµ„ï¼šè³¼ç‰©è»Šç¥è–ä¸å¯ä¾µçŠ¯ï¼Œå¿…é ˆç¶“é ˜è¢–æ‰¹å‡†ã€‚\nè£é£¾çµ„ï¼šè£é£¾ä½ç½®å¿…é ˆç”±é ˜è¢–æ±ºå®šã€‚",
                detective: {
                    keyword: "<br>ã€æ¡è³¼çµ„ã€‘é—œéµè©ï¼šç•¶æåŠ ã€Œè²´ã€ / ã€Œé ç®—ã€ / ã€Œæ²’éŒ¢ã€ ç­‰åƒ¹æ ¼æ•æ„Ÿè©±é¡Œæ™‚ã€‚ <span class='secret-highlight'>åæ‡‰ï¼šå¤§æ‰‹ä¸€æ®èªªã€é»éƒ½é»äº†ï¼ã€æˆ–ã€è²·ï¼ã€</span><br>ã€è£é£¾çµ„ã€‘æåŠã€é€™è£¡/é‚£é‚Š+æ¯”åŠƒã€<span class='secret-highlight'>åæ‡‰ï¼šè±æ‹‡æŒ‡èªªã€ç‰¹åˆ¥å¥½ï¼ã€</span>",
                    action: "<span class='secret-highlight'>è½å¾é ˜è¢–ç¾å¯¦å·¥ä½œåˆ†é…ã€‚ç•¶æš—è™Ÿè§¸ç™¼æ™‚ï¼Œè‡ªç„¶åŸ·è¡Œä¸Šè¿°å‹•ä½œã€‚"
                },
                undercover: {
                    hint: "<br>ã€æ¡è³¼çµ„ã€‘é—œéµè©ï¼šç•¶æåŠ*****  <span class='secret-highlight'>åæ‡‰ï¼šè±ªçˆ½</span><br>ã€è£é£¾çµ„ã€‘é—œæ©Ÿè©ï¼šç•¶æåŠ*****<span class='secret-highlight'>åæ‡‰ï¼šé«˜åº¦è®šè³</span>",
                    action: "<span class='secret-highlight'>å‡è£åšäº‹ã€‚è½åˆ°é—œéµè©æ™‚ï¼Œæ ¹æ“šæç¤ºä¸¦è§€å¯Ÿåˆ¥äººï¼Œä½œå‡ºåµæ¢å€‘å¯èƒ½æœƒæœ‰çš„åæ‡‰ã€‚</span>"
                }
            },
            2: {
                title: "ç¬¬äºŒè¼ªï¼šå‚™æ–™ç’°ç¯€ (3äººåŸ·è¡Œ)",
                leader_rule: "ã€å»šæˆ¿ä¸»ç†äººã€‘\næ‰€æœ‰é£Ÿæè™•ç†é †åºã€äººå“¡åˆ†é…ç”±é ˜è¢–æŒ‡æ´¾ã€‚é ˜è¢–æœªä¸‹ä»¤ï¼Œä¸å¾—ç§è‡ªæ‹†å°é£Ÿæã€‚",
                detective: {
                    keyword: "<br>é—œéµè©ï¼šç•¶æåŠã€å°å¿ƒ/åˆ€/å±éšª/æµè¡€ã€  <span class='secret-highlight'>åæ‡‰ï¼šç«‹åˆ»åœæ‰‹ï¼Œé€£èªªå…©æ¬¡ã€æ²’äº‹ã€æ²’äº‹ã€ã€‚</span>",
                    action: "<span class='secret-highlight'>è½å¾é ˜è¢–ç¾å¯¦å·¥ä½œåˆ†é…ã€‚ç•¶æš—è™Ÿè§¸ç™¼æ™‚ï¼Œè‡ªç„¶åŸ·è¡Œä¸Šè¿°å‹•ä½œã€‚"
                },
                undercover: {
                    hint: "<br>é—œéµè©ï¼šç•¶æåŠ*****  <span class='secret-highlight'>åæ‡‰ï¼šï¼ˆèªè¨€å›æ‡‰ï¼‰è¡¨ç¤ºå®‰æ’«/ç‹€æ³è§£é™¤</span>",
                    action: "<span class='secret-highlight'>å‡è£åšäº‹ã€‚è½åˆ°é—œéµè©æ™‚ï¼Œæ ¹æ“šæç¤ºä¸¦è§€å¯Ÿåˆ¥äººï¼Œä½œå‡ºåµæ¢å€‘å¯èƒ½æœƒæœ‰çš„åæ‡‰ã€‚</span>"
                }
            },
            3: {
                title: "ç¬¬ä¸‰è¼ªï¼šç‡’çƒ¤é–‹å§‹ (4äººåŸ·è¡Œ)",
                leader_rule: "ã€ç¯ç«å¯©åˆ¤å®˜ã€‘\nç‡’çƒ¤é †åºèˆ‡äº«ç”¨é †åºç”±é ˜è¢–è£æ±ºã€‚é ˜è¢–æœ‰æ¬Šæ±ºå®šã€åŠ èœ‚èœœ/é‚„æ˜¯å­œç„¶ç²‰ã€ã€‚",
                detective: {
                    keyword: "<br>é—œéµè©ï¼šç•¶æåŠã€ç†Ÿäº†/å¯ä»¥åƒ/ç„¦äº†ã€<span class='secret-highlight'>åæ‡‰ï¼šèˆ‰èµ·é¤å…·æŒ‡å¤©ï¼ˆåƒèˆ‰åŠä¸€æ¨£ï¼‰ã€‚</span>",
                    action: "<span class='secret-highlight'>è½å¾é ˜è¢–ç¾å¯¦å·¥ä½œåˆ†é…ã€‚ç•¶æš—è™Ÿè§¸ç™¼æ™‚ï¼Œè‡ªç„¶åŸ·è¡Œä¸Šè¿°å‹•ä½œã€‚"
                },
                undercover: {
                    hint: "<br>é—œéµè©ï¼šç•¶æåŠ*****  <span class='secret-highlight'>åæ‡‰ï¼šï¼ˆç‰©å“äº’å‹•ï¼‰é¤å…·ç›¸é—œ</span>",
                    action: "<span class='secret-highlight'>å‡è£åšäº‹ã€‚è½åˆ°é—œéµè©æ™‚ï¼Œæ ¹æ“šæç¤ºä¸¦è§€å¯Ÿåˆ¥äººï¼Œä½œå‡ºåµæ¢å€‘å¯èƒ½æœƒæœ‰çš„åæ‡‰ã€‚</span>"
                }
            }
        };
        const ROLE_MAP = { 'God': 'çŒœå¿Œä¹‹ç¥', 'Detective': 'åµæ¢', 'Undercover': 'è‡¥åº•', 'Assassin': 'åˆºå®¢' };

        let myName = localStorage.getItem("u_name") || "";
        let selectedAvatar = null;
        let currentFileIndex = 0;
        let serverData = {};
        let mySelectedTeam = [];
        let myAssassinTarget = null;
        let myGiftNum = null;
        let discussionInterval = null; 

        // [ä¿®å¾©] å…¨å±€é»æ“ŠéŸ³æ•ˆ
        document.addEventListener('click', function(e) {
            // ä½¿ç”¨ closest æŸ¥æ‰¾æœ€è¿‘çš„æŒ‰éˆ•å…ƒç´ 
            const btn = e.target.closest('button') || e.target.closest('.btn') || e.target.closest('.nav-btn') || e.target.closest('.avatar-option') || e.target.closest('.player-tile') || e.target.closest('.vote-btn') || e.target.closest('.number-btn') || e.target.closest('.emoji-btn');
            
            if (btn) {
                document.getElementById('sfx-click').currentTime = 0;
                document.getElementById('sfx-click').play().catch(e => {});
            }
        });

        window.onload = function() { renderAvatarGrid(); };

        db.ref('game').on('value', (snap) => {
            document.getElementById('loading').style.display = 'none';
            const data = snap.val();
            if (!data) return;
            serverData = data;
            
            // ç•¶æœ‰äººç¢ºèªèº«ä»½æ™‚ï¼Œåˆ·æ–°æª”æ¡ˆå¡ç‰‡
            if (document.getElementById('page-1').classList.contains('active')) {
                updateFileCardDisplay();
            }

            // Task: ç›£è½æ‡²ç½°åˆ—è¡¨æ›´æ–°
            if ((data.punishmentSubmissions || !data.punishmentSubmissions) && document.getElementById('page-punishment').classList.contains('active')) {
                renderPunishmentPage(data);
            }

             // Task: ç›£è½ç¦®ç‰©é †åºæ›´æ–°
            if (data.giftDrawOrder && document.getElementById('page-7').classList.contains('active')) {
                initGiftPage();
            }

            handleStateTransition(data);
        });

        function handleStateTransition(data) {
            const state = data.state;
            const amIRegistered = myName && data.players && data.players[myName] && data.players[myName].joined;

            if (state === 1) {
                if (amIRegistered) {
                    const currentPage = document.querySelector('.page.active').id;
                    if (currentPage === 'page-0' || currentPage === 'page-1') showGlobalPage('fingerprint'); 
                } else {
                    if (document.getElementById('page-1').classList.contains('active')) updateFileCardDisplay();
                }
            } 
            else if (state === 2) {
                if (amIRegistered) {
                    const currentPage = document.querySelector('.page.active').id;
                    if (currentPage === 'page-0' || currentPage === 'page-1') showGlobalPage('fingerprint'); 
                    if (currentPage === 'page-2') updateLobbyInfo(); 
                } 
            }
            else if (state === 4) { showGlobalPage('4'); renderGamePhase(data); }
            else if (state === 5) { showGlobalPage('5'); setupAssassinPhase(data); }
            else if (state === 6) { showGlobalPage('6'); renderFinalResult(data); }
            else if (state === 6.5) { showGlobalPage('punishment'); renderPunishmentPage(data); }
            else if (state === 7) { showGlobalPage('7'); initGiftPage(); }
            else if (state === 0) { showGlobalPage('0'); }
            
// ç™»å…¥å¾Œé¡¯ç¤ºç­†è¨˜æœ¬æŒ‰éˆ•èˆ‡æ‡¸æµ®æŒ‰éˆ•
            if (amIRegistered) {
                document.getElementById('notebook-btn').style.display = 'flex';
                document.getElementById('fab-dossier').style.display = 'flex';
                document.getElementById('fab-lobby').style.display = 'flex';
                
                // æ›´æ–°æ‡¸æµ®æŒ‰éˆ•çš„é ­åƒ (å¾ serverData è®€å–)
                if (data.players && data.players[myName] && data.players[myName].avatar) {
                    document.getElementById('fab-dossier').style.backgroundImage = `url('${data.players[myName].avatar}')`;
                }
            }
        }

        // æ–°å¢ï¼šå¸¶æœ‰æ³¨æ„äº‹é …çš„é–‹å§‹å‡½æ•¸
        window.startGameWithInstructions = () => {
            alert("**éŠæˆ²æ³¨æ„äº‹é …**\n1. é»æ“Šé–‹å§‹çœ‹è¦‹è‡ªå·±ã€Œsecret agentã€é é¢\n2. æ»‘åˆ°æœ€åº•é»æ“Šã€Œå‰å¾€æ¡ˆä»¶å¤§å»³æŒ‰éˆ•ã€\n3. æ‰“é–‹ã€Œæ¡ˆä»¶ä¸€ã€æŸ¥çœ‹æº–å‚™è£é£¾å’Œæ€ªç¦®ç‰©\n4. çœ‹ç¾¤çµ„ç½®é ‚çœ‹éŠæˆ²è¦å‰‡");
            window.tryStartGame();
        };

        window.tryStartGame = async () => { showGlobalPage('1'); };

        function showGlobalPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const targetId = pageId.startsWith('page-') ? pageId : `page-${pageId}`;
            const target = document.getElementById(targetId);
            if (target) target.classList.add('active');
            
            if (pageId === '1') { updateFileCardDisplay(); renderAvatarGrid(); }
            if (pageId === '3') { updateDecoRuleText(); } 
            if (pageId === 'dossier') { revealDossierContent(); }
        }

        window.showLocalPage = (pageId) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            let target = pageId;
            if (pageId === 4.1) target = "4-1"; 
            document.getElementById(`page-${target}`).classList.add('active');
            if (pageId === '7') initGiftPage();
            if (pageId === 3 || pageId === '3') updateDecoRuleText();
            if (pageId === 'dossier') { revealDossierContent(); }
        }

        async function updateDecoRuleText() {
            let snap = await db.ref(`game/players/${myName}`).get();
            let pData = snap.val();
            if (!pData || !pData.role) return;
            const decoText = document.getElementById('mission-deco-text');
            if (pData.role === 'Undercover' || pData.role === 'Assassin') {
                decoText.innerText = "è«‹è³¼è²·ã€å£è£é£¾ã€æ“¾äº‚æ´¾å°ï¼Œé ç®—é‡‘é¡ç‚º30-50å…ƒã€‚";
                decoText.style.color = "var(--fail-red)";
                decoText.style.fontWeight = "bold";
            } else {
                decoText.innerText = "è«‹è³¼è²·ã€å¥½è£é£¾ã€è®“æ´¾å°é€²è¡Œé †åˆ©ï¼Œé ç®—é‡‘é¡ç‚º30-50å…ƒã€‚";
                decoText.style.color = "var(--ink)";
                decoText.style.fontWeight = "bold";
            }
            if (pData.giftRule) {
                document.getElementById('gift-rule-btn').style.display = 'none';
                document.getElementById('gift-rule-display').style.display = 'block';
                const rule = document.getElementById('gift-rule-text');
                const desc = document.getElementById('gift-rule-desc');
                rule.innerText = pData.giftRule;
                desc.innerText = GIFT_DESCRIPTIONS[pData.giftRule] || "";
                rule.classList.add('stamp-animate');
            }
        }

        window.changeFile = (direction) => {
            closeFileAvatarSection();
            currentFileIndex += direction;
            if (currentFileIndex < 0) currentFileIndex = PLAYERS_LIST.length - 1;
            if (currentFileIndex >= PLAYERS_LIST.length) currentFileIndex = 0;
            updateFileCardDisplay();
        };

        function updateFileCardDisplay() {
            const name = PLAYERS_LIST[currentFileIndex];
            document.getElementById('file-name').innerText = name;
            document.getElementById('file-number').innerText = (currentFileIndex + 1).toString().padStart(2, '0');
            const isTaken = serverData.players && serverData.players[name] && serverData.players[name].joined;
            const isMe = (name === myName);
            const btn = document.getElementById('select-name-btn');
            const status = document.getElementById('file-status');
            if (isTaken && !isMe) { status.innerText = "LOCKED"; status.classList.add('taken'); btn.disabled = true; btn.innerText = "æ­¤æª”æ¡ˆå·²è¢«é–å®š"; btn.style.opacity = 0.5; }
            else { status.innerText = "AVAILABLE"; status.classList.remove('taken'); btn.disabled = false; btn.innerText = "é–‹å•Ÿæª”æ¡ˆ (SELECT)"; btn.style.opacity = 1; }
        }

        window.openFileAvatarSection = () => { 
            document.getElementById('select-name-btn').style.display = 'none'; 
            document.getElementById('avatar-section').style.display = 'block'; 
            myName = PLAYERS_LIST[currentFileIndex]; 
            // æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById('birthday-input').value = "";
            renderAvatarGrid(); 
        };

        window.closeFileAvatarSection = () => { document.getElementById('select-name-btn').style.display = 'block'; document.getElementById('avatar-section').style.display = 'none'; selectedAvatar = null; document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected')); document.getElementById('confirm-btn').disabled = true; };
        
        function renderAvatarGrid() {
            const grid = document.getElementById('avatar-selection-grid');
            if (grid.children.length > 0) return;
            AVATAR_SEEDS.forEach(seed => {
                const div = document.createElement('div'); div.className = 'avatar-option';
                const url = `https://api.dicebear.com/9.x/adventurer/svg?seed=${seed}`;
                div.innerHTML = `<img src="${url}" class="avatar-img">`;
                div.onclick = () => { document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected')); div.classList.add('selected'); selectedAvatar = url; document.getElementById('confirm-btn').disabled = false; };
                grid.appendChild(div);
            });
        }

        // ä¿®æ”¹ï¼šç”Ÿæ—¥é©—è­‰é‚è¼¯èˆ‡éŒ¯èª¤è¨Šæ¯
        window.confirmIdentity = () => {
            if (!myName || !selectedAvatar) return;
            
            const inputDob = document.getElementById('birthday-input').value.trim();
            const correctDob = BIRTHDAYS[myName];

            if (inputDob !== correctDob) {
                // ä¿®æ”¹éŒ¯èª¤è¨Šæ¯
                alert("åˆ¥å·çœ‹åˆ¥äººçš„æª”æ¡ˆï¼ï¼");
                document.getElementById('birthday-input').value = "";
                return;
            }

            localStorage.setItem("u_name", myName);
            window.showLocalPage('fingerprint');
            db.ref(`game/players/${myName}`).update({ joined: true, avatar: selectedAvatar }).then(() => {
                checkAndStartGameLogic();
            });
        };

        async function checkAndStartGameLogic() {
            db.ref('game').transaction((gameData) => {
                if (gameData && !gameData.rolesAssigned) {
                    let roles = ["God", "Detective", "Detective", "Detective", "Detective", "Detective", "Undercover", "Assassin"];
                    for (let i = roles.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [roles[i], roles[j]] = [roles[j], roles[i]]; }
                    if (!gameData.players) gameData.players = {};
                    PLAYERS_LIST.forEach((p, i) => {
                        if (!gameData.players[p]) gameData.players[p] = {};
                        gameData.players[p].role = roles[i];
                        gameData.players[p].giftRule = ""; 
                    });
                    gameData.rolesAssigned = true;
                    gameData.state = 2; 
                }
                return gameData;
            });
        }

        window.unlockDossier = () => { window.showLocalPage('dossier'); revealDossierContent(); };
        
        // ä¿®æ”¹ï¼šé€²å…¥å¤§å»³æ™‚åˆå§‹åŒ– Emoji é¸æ“‡å™¨
        window.enterLobby = () => { 
            window.showLocalPage('2'); 
            updateLobbyInfo(); 
            renderLobbyEmojiBar(); 
        };

        // æ–°å¢ï¼šæ¸²æŸ“æ¡ˆä»¶å¤§å»³çš„ Emoji é¸æ“‡æ¬„
        function renderLobbyEmojiBar() {
            const container = document.getElementById('emoji-selector');
            if (container.children.length > 0) return; // é¿å…é‡è¤‡æ¸²æŸ“
            
            EMOJI_OPTIONS.forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-btn';
                btn.innerText = emoji;
                btn.onclick = () => setLobbyEmoji(emoji);
                container.appendChild(btn);
            });
        }

        // æ–°å¢ï¼šè¨­å®š Emoji ä¸¦åŒæ­¥åˆ° Firebase
        function setLobbyEmoji(emoji) {
            db.ref(`game/players/${myName}`).update({ statusEmoji: emoji });
        }

        // ä¿®æ”¹ï¼šJasmine ç”Ÿæ—¥å½ˆçª—èˆ‡è¡¨æƒ…
        async function revealDossierContent() {
            const snap = await db.ref(`game/players/${myName}`).get();
            let pData = snap.val();
            if (!pData || !pData.role) { setTimeout(() => revealDossierContent(), 1000); return; }
            document.getElementById('dossier-codename').innerText = myName;
            
            // é¡¯ç¤ºç”Ÿæ—¥
            if (BIRTHDAYS[myName]) {
                document.getElementById('dossier-birthday').innerText = BIRTHDAYS[myName];
            }

            if(pData.avatar) document.getElementById('dossier-photo').src = pData.avatar;
            
            // Jasmine å½©è›‹èˆ‡å½ˆçª—
            const hatContainer = document.getElementById('birthday-hat-container');
            hatContainer.innerHTML = ''; // æ¸…ç©ºèˆŠçš„
            
            if (myName === 'Jasmine') {
                // 1. å¢åŠ æ›´å¤š Emoji
                const hat = document.createElement('div');
                hat.className = 'birthday-hat';
                hat.innerHTML = 'ğŸ¥³ğŸ‚ğŸ‰'; 
                hatContainer.appendChild(hat);

                // 2. æª¢æŸ¥æ˜¯å¦é¡¯ç¤ºéç”Ÿæ—¥å½ˆçª—
                const hasSeenBirthday = localStorage.getItem("jasmine_bday_seen");
                if (!hasSeenBirthday) {
                    // é¡¯ç¤ºè‡ªå®šç¾©å½ˆçª— (ä¸å†æœ‰ç´…å…‰èƒŒæ™¯)
                    setTimeout(() => {
                        document.getElementById('birthday-modal').style.display = 'flex';
                    }, 500);
                    // æ¨™è¨˜å·²è®€
                    localStorage.setItem("jasmine_bday_seen", "true");
                }
            }

            const stamp = document.getElementById('dossier-role-stamp');
            const desc = document.getElementById('dossier-objective');
            const teamInfo = document.getElementById('dossier-teammates');
            stamp.classList.remove('stamp-animate'); void stamp.offsetWidth; stamp.classList.add('stamp-animate');
            const roleName = ROLE_MAP[pData.role];
            stamp.innerText = roleName;
            document.getElementById('dossier-role').innerText = roleName;
            if (pData.role === 'God') {
                stamp.style.color = "purple"; desc.innerText = "ä½ æ˜¯é€™å ´æ´¾å°çš„éˆé­‚äººç‰©ã€‚ä½ çŸ¥é“èª°æ˜¯å£äººï¼Œä½†ä½ å¿…é ˆéš±è—èº«ä»½ã€‚";
                const badGuys = Object.entries(serverData.players).filter(([k,v]) => v.role === 'Undercover' || v.role === 'Assassin').map(([k,v]) => k);
                teamInfo.style.display = 'block'; teamInfo.innerText = `å«Œç–‘åå–® (å£äºº): ${badGuys.join(', ')}`;
            } else if (pData.role === 'Detective') {
                stamp.style.color = "#111"; desc.innerText = "ä½ åªçŸ¥é“è‡ªå·±æ˜¯å¥½äººï¼Œå¿…é ˆé€éè§€å¯Ÿå’ŒæŠ•ç¥¨æ‰¾å‡ºå€¼å¾—ä¿¡ä»»çš„å¤¥ä¼´ï¼Œå®Œæˆæ´¾å°ä»»å‹™ã€‚";
                teamInfo.style.display = 'none';
            } else if (pData.role === 'Undercover') {
                stamp.style.color = "var(--fail-red)"; desc.innerText = "ä½ çš„ä»»å‹™æ˜¯å”åŠ©åˆºå®¢ï¼Œåœ¨ä¸è¢«ç™¼ç¾çš„æƒ…æ³ä¸‹ç ´å£æ´¾å°ä»»å‹™ã€‚";
                const teammates = Object.entries(serverData.players).filter(([k,v]) => v.role === 'Assassin').map(([k,v]) => k);
                teamInfo.style.display = 'block'; teamInfo.innerText = `ä½ çš„åˆºå®¢éšŠå‹: ${teammates.join(', ')}`;
            } else if (pData.role === 'Assassin') {
                stamp.style.color = "var(--fail-red)"; desc.innerText = "ç ´å£ä»»å‹™ã€‚å¦‚æœåµæ¢è´äº†ï¼Œä½ é‚„æœ‰æœ€å¾Œä¸€æ¬¡æ©Ÿæœƒï¼šæ‰¾å‡ºèª°æ˜¯ã€ŒçŒœå¿Œä¹‹ç¥ã€ä¸¦åˆºæ®ºä»–ã€‚";
                const teammates = Object.entries(serverData.players).filter(([k,v]) => v.role === 'Undercover').map(([k,v]) => k);
                teamInfo.style.display = 'block'; teamInfo.innerText = `ä½ çš„è‡¥åº•éšŠå‹: ${teammates.join(', ')}`;
            }
        }

        // é—œé–‰ç”Ÿæ—¥å½ˆçª—
        window.closeBirthdayModal = () => {
            document.getElementById('birthday-modal').style.display = 'none';
        };

        // ä¿®æ”¹ï¼šæ›´æ–°å¤§å»³è³‡è¨Šæ™‚åŒæ™‚é¡¯ç¤º Emoji
        async function updateLobbyInfo() {
            document.getElementById('lobby-player-name').innerText = myName;
            const snap = await db.ref(`game/players/${myName}`).get();
            const pData = snap.val();
            
            if (pData && pData.avatar) document.getElementById('lobby-avatar-img').src = pData.avatar;
            
            // æ›´æ–°è£é£¾ Emoji
            if (pData && pData.statusEmoji) {
                document.getElementById('lobby-emoji-display').innerText = pData.statusEmoji;
            }

            if (pData && pData.role) {
                document.getElementById('lobby-player-role').innerText = `[ ${ROLE_MAP[pData.role]} ]`;
                const hidden = document.getElementById('lobby-player-role').classList.contains('blur-text');
                document.getElementById('lobby-player-role').className = hidden ? "blur-text" : "reveal-text";
            }
            const results = serverData.questResults || []; const percent = results.length * 33.33; document.getElementById('lobby-progress').style.width = percent + '%';
        }
        window.toggleRoleVisibility = () => { const el = document.getElementById('lobby-player-role'); el.className = el.classList.contains('blur-text') ? "reveal-text" : "blur-text"; };
        
        window.revealRule = async () => {
            const snap = await db.ref(`game/players/${myName}`).get(); let pData = snap.val();
            if (!pData || !pData.giftRule) { const rule = GIFT_RULES[Math.floor(Math.random() * GIFT_RULES.length)]; await db.ref(`game/players/${myName}/giftRule`).set(rule); pData = { ...pData, giftRule: rule }; }
            document.getElementById('gift-rule-btn').style.display = 'none'; document.getElementById('gift-rule-display').style.display = 'block';
            const ruleText = document.getElementById('gift-rule-text'); const ruleDesc = document.getElementById('gift-rule-desc');
            ruleText.innerText = pData.giftRule; ruleDesc.innerText = GIFT_DESCRIPTIONS[pData.giftRule] || ""; ruleText.classList.remove('stamp-animate'); void ruleText.offsetWidth; ruleText.classList.add('stamp-animate');
        };

// ä¿®æ”¹å¾Œï¼šæ™ºèƒ½é€²å…¥éŠæˆ²ï¼ˆæœƒè¨˜æ†¶é€²åº¦ï¼‰
        window.enterMainGame = () => {
            // 1. å¯†ç¢¼æª¢æŸ¥ (ä¿æŒä¸è®Š)
            const isUnlocked = localStorage.getItem("case2_lock_secure");
            if (!isUnlocked) {
                let password = prompt("âš  RESTRICTED AREA âš \nè«‹è¼¸å…¥æ¡ˆä»¶å¯†ç¢¼ï¼š");
                if (password !== "2324") {
                    alert("å­˜å–è¢«æ‹’ (ACCESS DENIED)");
                    return;
                }
                localStorage.setItem("case2_lock_secure", "true");
            }

            // 2. æ™ºèƒ½åˆ¤æ–·ç‹€æ…‹ (Smart Resume)
            // æª¢æŸ¥ä¼ºæœå™¨ç•¶å‰çš„ç‹€æ…‹ï¼Œæ±ºå®šè·³è½‰å»å“ªè£¡ï¼Œè€Œä¸æ˜¯ç„¡è…¦è·³å» Page 4
            const currentState = serverData.state;

            if (currentState === 5) {
                // å¦‚æœæ˜¯åˆºæ®ºç’°ç¯€ï¼Œè·³å» Page 5
                showGlobalPage('5'); 
                setupAssassinPhase(serverData);
            } else if (currentState === 6) {
                // å¦‚æœå·²ç¶“çµå±€ï¼Œè·³å» Page 6
                showGlobalPage('6'); 
                renderFinalResult(serverData);
            } else if (currentState === 6.5) {
                // å¦‚æœæ˜¯æ‡²ç½°ç’°ç¯€
                showGlobalPage('punishment');
                renderPunishmentPage(serverData);
            } else if (currentState === 7) {
                 // å¦‚æœæ˜¯ç¦®ç‰©ç’°ç¯€
                showGlobalPage('7');
                initGiftPage();
            } else if (currentState === 8) {
                 // å¦‚æœæ˜¯æœ€å¾Œæ’’èŠ±
                showGlobalPage('8');
            } else if (currentState === 4) {
                 // éŠæˆ²æ­£åœ¨é€²è¡Œä¸­ï¼Œå›åˆ° Page 4 ä¸¦é‡æ–°æ¸²æŸ“ç•¶å‰éšæ®µ
                 showGlobalPage('4');
                 renderGamePhase(serverData);
            } else {
                // 3. åªæœ‰ç•¶ç‹€æ…‹é‚„æ²’é–‹å§‹ (<4) æ™‚ï¼Œæ‰åŸ·è¡Œåˆå§‹åŒ–é–‹å•ŸéŠæˆ²
                showGlobalPage('4');
                if (!serverData.roundPhase) {
                    const randomLeader = Math.floor(Math.random() * PLAYERS_LIST.length);
                    db.ref('game').update({ state: 4, currentRound: 1, leaderIndex: randomLeader, roundPhase: 'intro', questResults: [] });
                }
            }
        };

        // --- æ ¸å¿ƒéŠæˆ²æµç¨‹æ§åˆ¶ ---
        function renderGamePhase(data) {
            const round = data.currentRound || 1;
            const safeLeaderIndex = (data.leaderIndex >= 0 && data.leaderIndex < PLAYERS_LIST.length) ? data.leaderIndex : 0;
            const leaderName = PLAYERS_LIST[safeLeaderIndex];
            const phase = data.roundPhase || 'intro';
            
            document.getElementById('round-indicator').innerText = `ROUND ${round} / 3`;
            updateScoreboard(data);
            
            ['phase-round-intro', 'phase-rules', 'phase-discussion', 'phase-assignment', 'phase-mission', 'phase-result'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });

            if (phase !== 'discussion' && discussionInterval) {
                clearInterval(discussionInterval);
                discussionInterval = null;
            }

            if (phase === 'intro') {
                document.getElementById('phase-round-intro').style.display = 'block';
                const scenario = GAME_SCENARIOS[round];
                document.getElementById('intro-title').innerText = scenario.title;
                document.getElementById('intro-leader-name').innerText = leaderName;
            } 
            else if (phase === 'rules') {
                document.getElementById('phase-rules').style.display = 'block';
                const scenario = GAME_SCENARIOS[round];
                document.getElementById('rules-public-display').innerText = scenario.leader_rule;
                
                const myRole = data.players[myName].role;
                const amILeader = (myName === leaderName);
                const isBadGuy = (myRole === 'Undercover' || myRole === 'Assassin');
                let secretMissionText = "";

                if (isBadGuy) {
                    if (amILeader) {
                         secretMissionText = "<strong style='color:var(--accent-red)'>[é–“è«œé ˜è¢–ç‰¹æ¬Š] åµæ¢æš—è™Ÿï¼š</strong><br>" + scenario.detective.keyword + "<br>" + scenario.detective.action;
                    } else {
                         secretMissionText = scenario.undercover.hint + "<br>" + scenario.undercover.action;
                    }
                } else {
                    secretMissionText = scenario.detective.keyword + "<br>" + scenario.detective.action;
                }
                
                document.getElementById('rules-secret-display').innerHTML = secretMissionText;
                document.querySelectorAll('.flip-container').forEach(el => el.classList.remove('flipped'));

                if (amILeader) {
                    document.getElementById('leader-start-discussion-btn').style.display = 'block';
                    document.getElementById('member-waiting-rules').style.display = 'none';
                } else {
                    document.getElementById('leader-start-discussion-btn').style.display = 'none';
                    document.getElementById('member-waiting-rules').style.display = 'block';
                }
            }
            else if (phase === 'discussion') {
                document.getElementById('phase-discussion').style.display = 'block';
                
                // è¨è«–ç’°ç¯€ç¬¬ä¸€æ¬¡é€²å…¥æ™‚æ’­æ”¾è­¦æƒ•éˆ´è²
                if (!discussionInterval) { 
                     document.getElementById('sfx-alert').play().catch(e => {});
                }

                const scenario = GAME_SCENARIOS[round];
                const myRole = data.players[myName].role;
                const amILeader = (myName === leaderName);
                const isBadGuy = (myRole === 'Undercover' || myRole === 'Assassin');
                let secretMissionText = "";
                if (isBadGuy) {
                    if (amILeader) secretMissionText = "<strong style='color:var(--accent-red)'>[é–“è«œé ˜è¢–ç‰¹æ¬Š] åµæ¢æš—è™Ÿï¼š</strong><br>" + scenario.detective.keyword + "<br>" + scenario.detective.action;
                    else secretMissionText = scenario.undercover.hint + "<br>" + scenario.undercover.action;
                } else {
                    secretMissionText = scenario.detective.keyword + "<br>" + scenario.detective.action;
                }
                document.getElementById('rules-secret-display-discussion').innerHTML = secretMissionText;

                const endTime = data.discussionEndTime || 0;
                if (!discussionInterval) {
                    const display = document.getElementById('timer-display');
                    discussionInterval = setInterval(() => {
                        const now = Date.now(); 
                        const timeLeft = Math.floor((endTime - now) / 1000);

                        if (timeLeft < 0) {
                            clearInterval(discussionInterval);
                            display.innerText = "00:00";
                            if (myName === leaderName) { startAssignmentPhase(); } 
                        } else {
                            let m = Math.floor(timeLeft / 60);
                            let s = timeLeft % 60;
                            display.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                        }
                    }, 500); 
                }
            }
            else if (phase === 'assignment') {
                document.getElementById('phase-assignment').style.display = 'block';
                if (myName === leaderName) {
                    document.getElementById('leader-controls').style.display = 'block';
                    document.getElementById('member-waiting-assignment').style.display = 'none';
                    renderTeamSelectGrid(round);
                } else {
                    document.getElementById('leader-controls').style.display = 'none';
                    document.getElementById('member-waiting-assignment').style.display = 'block';
                }
            } 
            else if (phase === 'mission') {
                document.getElementById('phase-mission').style.display = 'block';
                const team = data.currentTeam || [];
                document.getElementById('mission-team-names').innerText = team.join(', ');
                const myVotes = data.missionVotes || {};
                
                document.querySelectorAll('.vote-btn').forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = 1;
                    btn.innerText = (btn.id === 'vote-btn-success') ? 'ä»»å‹™æˆåŠŸ' : 'ä»»å‹™å¤±æ•—';
                });

                if (team.includes(myName) && (myVotes[myName] === undefined)) {
                    document.getElementById('voting-area').style.display = 'block';
                    document.getElementById('voting-wait').style.display = 'none';
                    const myRole = data.players[myName].role;
                    if (myRole === 'Detective' || myRole === 'God') {
                        document.getElementById('vote-btn-fail').disabled = true;
                        document.getElementById('vote-btn-fail').style.opacity = 0.3;
                        document.getElementById('good-guy-warning').style.display = 'block';
                    } else {
                        document.getElementById('vote-btn-fail').disabled = false;
                        document.getElementById('good-guy-warning').style.display = 'none';
                    }
                } else {
                    document.getElementById('voting-area').style.display = 'none';
                    document.getElementById('voting-wait').style.display = 'block';
                    document.getElementById('voting-wait').innerText = team.includes(myName) ? "å·²æäº¤" : "ç­‰å¾…æˆå“¡åŸ·è¡Œ...";
                }
            } 
            else if (phase === 'result') {
                document.getElementById('phase-result').style.display = 'block';
                const votes = Object.values(data.missionVotes || {});
                const failCount = votes.filter(v => v === false).length;
                const resultText = document.getElementById('round-result-text');
                const revealDiv = document.getElementById('vote-reveal');
                if (failCount > 0) { resultText.innerText = "ä»»å‹™å¤±æ•—"; resultText.style.color = "var(--fail-red)"; }
                else { resultText.innerText = "ä»»å‹™æˆåŠŸ"; resultText.style.color = "var(--success-green)"; }
                revealDiv.innerHTML = '';
                votes.sort(() => Math.random() - 0.5);
                votes.forEach(v => { const span = document.createElement('span'); span.innerText = v ? "â­•" : "âŒ"; span.style.fontSize = "1.5rem"; revealDiv.appendChild(span); });
                document.getElementById('next-round-btn').style.display = 'block';
                document.getElementById('waiting-host-msg').style.display = 'none';
            }
        }

        window.startRoundRules = () => { db.ref('game').update({ roundPhase: 'rules' }); };
        window.startRoundDiscussion = () => { const endTime = Date.now() + 180000; db.ref('game').update({ roundPhase: 'discussion', discussionEndTime: endTime }); };
        window.startAssignmentPhase = () => { db.ref('game').update({ roundPhase: 'assignment' }); };
        window.confirmAssignment = () => { db.ref('game').update({ roundPhase: 'mission', currentTeam: mySelectedTeam, missionVotes: null }); };

        function updateScoreboard(data) {
            const scores = data.questResults || [];
            for (let i = 0; i < 3; i++) {
                const elGame = document.getElementById(`game-score-${i+1}`);
                if (!elGame) continue;
                elGame.className = 'score-circle';
                if (i < scores.length) { 
                    const status = scores[i] ? 'success' : 'fail';
                    elGame.classList.add(status); 
                } else if (i === scores.length) { 
                    elGame.classList.add('current'); 
                }
            }
        }

        window.renderTeamSelectGrid = (round) => {
            const grid = document.getElementById('team-select-grid');
            if(!grid) return;
            grid.innerHTML = '';
            mySelectedTeam = [];
            const btn = document.getElementById('confirm-team-btn');
            btn.disabled = true;
            btn.innerText = "ç¢ºèªæŒ‡æ´¾ (CONFIRM)";
            btn.style.backgroundColor = '#999';

            PLAYERS_LIST.forEach(p => {
                const div = document.createElement('div'); div.className = 'player-tile'; div.innerText = p;
                div.onclick = () => {
                    if (mySelectedTeam.includes(p)) { 
                        mySelectedTeam = mySelectedTeam.filter(n => n !== p); div.classList.remove('selected'); 
                    } else { 
                        if (mySelectedTeam.length < ROUND_CONFIG[round - 1]) { mySelectedTeam.push(p); div.classList.add('selected'); } 
                    }
                    const req = ROUND_CONFIG[round - 1];
                    btn.disabled = (mySelectedTeam.length !== req);
                    if (!btn.disabled) { btn.style.backgroundColor = 'var(--ink)'; btn.style.color = '#fff'; } 
                    else { btn.style.backgroundColor = '#999'; btn.style.color = '#fff'; }
                };
                grid.appendChild(div);
            });
        };

        window.submitMissionVote = (vote) => {
            const btnSuccess = document.getElementById('vote-btn-success');
            const btnFail = document.getElementById('vote-btn-fail');
            
            btnSuccess.disabled = true;
            btnFail.disabled = true;
            
            if (vote) {
                btnSuccess.innerHTML = "å·²æäº¤ (æˆåŠŸ)";
                btnSuccess.style.opacity = "1";
                btnFail.style.opacity = "0.3";
            } else {
                btnFail.innerHTML = "å·²æäº¤ (å¤±æ•—)";
                btnFail.style.opacity = "1";
                btnSuccess.style.opacity = "0.3";
            }

            db.ref(`game/missionVotes/${myName}`).set(vote).then(() => {
                checkMissionComplete();
            });
        };

        async function checkMissionComplete() {
            const snap = await db.ref('game').get();
            const data = snap.val();
            if (Object.keys(data.missionVotes || {}).length === data.currentTeam.length) db.ref('game').update({ roundPhase: 'result' });
        }
        window.nextRound = async () => {
            const snap = await db.ref('game').get();
            const data = snap.val();
            const votes = Object.values(data.missionVotes || {});
            const isSuccess = (votes.filter(v => v === false).length === 0);
            const newResults = data.questResults || [];
            newResults.push(isSuccess);
            const failTotal = newResults.filter(r => r === false).length;
            const successTotal = newResults.filter(r => r === true).length;
            if (failTotal >= 2) db.ref('game').update({ state: 6, finalWinner: 'Evil', questResults: newResults });
            else if (successTotal >= 2) db.ref('game').update({ state: 5, questResults: newResults });
            else db.ref('game').update({ currentRound: (data.currentRound || 1) + 1, leaderIndex: ((data.leaderIndex || 0) + 1) % PLAYERS_LIST.length, roundPhase: 'intro', questResults: newResults, currentTeam: null, missionVotes: null });
        };

        function setupAssassinPhase(data) {
            const page5 = document.getElementById('page-5');
            page5.innerHTML = `
                <div id="sniper-layer" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; width:100%;">
                    <h2 style="color: white; margin-bottom: 20px; text-align: center; font-family: var(--font-en);">æ‹–å‹•æº–å¿ƒé–å®šã€ŒçŒœå¿Œä¹‹ç¥ã€</h2>
                    <div id="assassin-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:20px; padding: 20px; width: 100%; max-width: 400px;"></div>
                    <div style="margin-top: 30px; text-align: center; color: red; font-family: var(--font-en); font-size: 1.5rem; font-weight:bold;">TARGET: <span id="locked-target">NONE</span></div>
                    <button id="fire-btn" onclick="fireAssassin()" style="margin-top: 20px; background: red; color: white; border: 2px solid white; padding: 15px 30px; font-weight: bold; cursor: pointer; font-family: var(--font-en); letter-spacing: 2px;" disabled>FIRE</button>
                </div>
            `;
            if (data.players[myName].role !== 'Assassin') { page5.innerHTML = `<h1 style="color:red; text-align:center; margin-top:50px;">ASSASSIN IS AIMING...</h1>`; return; }
            const grid = document.getElementById('assassin-grid');
            PLAYERS_LIST.forEach(p => {
                if (serverData.players[p].role === 'Undercover' || serverData.players[p].role === 'Assassin') return;
                const div = document.createElement('div'); div.className = 'player-tile'; div.innerText = p;
                div.onclick = () => {
                    document.querySelectorAll('#assassin-grid .player-tile').forEach(el => { el.style.backgroundColor = '#fff'; el.style.color = '#000'; el.style.borderColor = '#000'; });
                    div.style.backgroundColor = 'red'; div.style.color = 'white'; div.style.borderColor = 'white';
                    myAssassinTarget = p; document.getElementById('locked-target').innerText = p; document.getElementById('fire-btn').disabled = false;
                };
                grid.appendChild(div);
            });
        }

        window.fireAssassin = () => {
            if (!myAssassinTarget) return;
            const targetRole = serverData.players[myAssassinTarget].role;
            db.ref('game').update({ state: 6, finalWinner: (targetRole === 'God' ? 'Evil' : 'Good'), assassinTarget: myAssassinTarget });
        };

function renderFinalResult(data) {
            const winner = data.finalWinner;
            const title = document.getElementById('final-winner');
            const reason = document.getElementById('final-reason');
            const rolesBox = document.getElementById('final-roles-reveal');
            
            // åˆ¤æ–· MVP (æŒæœ‰å¡ç‰‡è€…)
            let mvpName = null;
            if (winner === 'Evil') {
                title.innerText = "è‡¥åº•é™£ç‡Ÿç²å‹ï¼"; title.style.color = "var(--fail-red)";
                reason.innerText = data.assassinTarget ? `åˆºå®¢æˆåŠŸæ“Šæ®ºçŒœå¿Œä¹‹ç¥ (${data.assassinTarget})ï¼` : "è‡¥åº•ç ´å£äº†å…©æ¬¡ä»»å‹™ã€‚";
                
                // å£äººè´ï¼šåˆºå®¢æ˜¯ MVP
                const assassinEntry = Object.entries(data.players).find(([n, p]) => p.role === 'Assassin');
                if (assassinEntry) mvpName = assassinEntry[0];

            } else {
                title.innerText = "åµæ¢é™£ç‡Ÿç²å‹ï¼"; title.style.color = "var(--success-green)";
                reason.innerText = `åˆºå®¢å¤±æ•— (ç›®æ¨™: ${data.assassinTarget || 'ç„¡'})ï¼Œå¥½äººå®ˆè­·äº†æ´¾å°ï¼`;
                
                // å¥½äººè´ï¼šç¥æ˜¯ MVP
                const godEntry = Object.entries(data.players).find(([n, p]) => p.role === 'God');
                if (godEntry) mvpName = godEntry[0];
            }

            let html = "<h3>èº«ä»½æ­æ›‰ï¼š</h3>";
            Object.entries(data.players).forEach(([name, p]) => {
                let color = (p.role === 'Undercover' || p.role === 'Assassin') ? 'red' : 'black';
                html += `<div style="color:${color}">${name}: ${ROLE_MAP[p.role]}</div>`;
            });
            
            // --- ä¿®æ”¹é» 1ï¼šåœ¨çµæœé é¡¯ç¤ºå¼·è¡Œäº¤æ›å¡ (åƒ… MVP å¯è¦‹) ---
            if (mvpName === myName) {
                html += `<div class="special-card-display" style="margin-top:20px;">
                            <h3 style="margin:0; border:none; color:#fff;">ğŸƒ æ€ªç¦®ç‰©å¼·è¡Œäº¤æ›å¡</h3>
                            <small>çå‹µï¼šåœ¨ç¦®ç‰©äº¤æ›ç’°ç¯€ä½¿ç”¨</small>
                         </div>`;
            } else if (mvpName) {
                // è®“å…¶ä»–äººçŸ¥é“èª°æ‹¿äº†å¡ (å¯é¸)
                html += `<div style="margin-top:15px; font-size:0.9rem; color:#888;">
                            MVP çå‹µ (${mvpName})ï¼šç²å¾—æ€ªç¦®ç‰©å¼·è¡Œäº¤æ›å¡
                         </div>`;
            }

            rolesBox.innerHTML = html;
        }

        /* --- Task 2: æ‡²ç½°è½‰ç›¤é‚è¼¯ (ä¿®æ”¹) --- */
        window.enterPunishmentPhase = () => {
            db.ref('game').update({ state: 6.5, punishmentSubmissions: null });
        };

function renderPunishmentPage(data) {
            const myRole = data.players[myName].role;
            const winner = data.finalWinner;
            const isWinner = (winner === 'Evil' && (myRole === 'Undercover' || myRole === 'Assassin')) || 
                             (winner === 'Good' && (myRole === 'Detective' || myRole === 'God'));

            const instruction = document.getElementById('punishment-instruction');
            const inputArea = document.getElementById('punishment-input-area');
            const waitArea = document.getElementById('punishment-wait-area');
            const wheelArea = document.getElementById('punishment-wheel-area');
            const display = document.getElementById('roulette-display');
            
            // æŒ‰éˆ•å€‘
            const btnGoGift = document.getElementById('btn-go-gift');
            const btnSpin = document.getElementById('spin-btn');

            const submissions = data.punishmentSubmissions || {};
            const result = data.punishmentResult; 

            // è¨ˆç®—è´å®¶äººæ•¸
            const winningPlayers = Object.entries(data.players).filter(([n, p]) => {
                if (winner === 'Evil') return p.role === 'Undercover' || p.role === 'Assassin';
                return p.role === 'Detective' || p.role === 'God';
            }).map(([n, p]) => n);

            const submittedCount = Object.keys(submissions).length;
            const allSubmitted = submittedCount >= winningPlayers.length;

            // --- ğŸ”’ é è¨­å…¨éƒ¨é–æ­» ---
            if (btnSpin) {
                btnSpin.disabled = true; 
                btnSpin.style.opacity = 0.5;
                btnSpin.style.cursor = "not-allowed";
            }
            if (btnGoGift) {
                btnGoGift.disabled = true;
                btnGoGift.style.opacity = 0.5;
                btnGoGift.style.background = "#999";
                btnGoGift.style.borderColor = "#999";
            }

            if (!allSubmitted) {
                // --- éšæ®µ 1: ç­‰å¾…è¼¸å…¥ ---
                if(btnGoGift) btnGoGift.innerText = `ç­‰å¾…æ‡²ç½°æäº¤... (${submittedCount}/${winningPlayers.length})`;

                if (isWinner) {
                    if (submissions[myName]) {
                         instruction.innerText = "ã€ç­‰å¾…éšŠå‹ã€‘";
                         inputArea.style.display = 'none';
                         waitArea.style.display = 'block';
                         wheelArea.style.display = 'none';
                    } else {
                         instruction.innerText = "ã€å‹åˆ©è€…æ¬Šåˆ©ã€‘è«‹è¼¸å…¥ 1 å€‹æ‡²ç½°é¸é …ï¼š";
                         inputArea.style.display = 'block';
                         waitArea.style.display = 'none';
                         wheelArea.style.display = 'none';
                    }
                } else {
                    instruction.innerText = "ã€ç­‰å¾…å¯©åˆ¤ã€‘å‹åˆ©è€…æ­£åœ¨æ±ºå®šæ‡²ç½°...";
                    inputArea.style.display = 'none';
                    waitArea.style.display = 'block';
                    wheelArea.style.display = 'none';
                }
            } else {
                // --- éšæ®µ 2: è½‰ç›¤é–‹å•Ÿ ---
                inputArea.style.display = 'none';
                waitArea.style.display = 'none';
                wheelArea.style.display = 'block';

                if (result) {
                    // --- éšæ®µ 3: çµæœå·²å‡º ---
                    instruction.innerText = "ã€å¯©åˆ¤çµæŸã€‘æ‡²ç½°å·²å®šï¼";
                    display.innerText = result; 
                    display.style.color = "red";
                    display.style.transform = "scale(1.2)";
                    
                    if(btnSpin) {
                        btnSpin.disabled = true;
                        btnSpin.innerText = "çµæœå·²å‡º";
                    }

                    // ã€ä¿®æ”¹é‚è¼¯ã€‘ï¼šåªæœ‰è´å®¶å¯ä»¥è§£é–ï¼Œä¸”éœ€è¦è¼¸å…¥å¯†ç¢¼ï¼
                    if(btnGoGift) {
                        if (isWinner) {
                            // è´å®¶ï¼šè§£é–
                            btnGoGift.disabled = false;
                            btnGoGift.innerText = "âœ… ç¢ºèªæ‡²ç½°çµæŸ (VERIFY)";
                            btnGoGift.style.opacity = 1;
                            btnGoGift.style.background = "var(--ink)";
                            btnGoGift.style.borderColor = "var(--ink)";
                        } else {
                            // è¼¸å®¶ï¼šç¹¼çºŒé–ä½
                            btnGoGift.disabled = true;
                            btnGoGift.innerText = "ç­‰å¾…è´å®¶æ»¿æ„... (LOCKED)";
                            btnGoGift.style.opacity = 0.5;
                        }
                    }

                } else {
                    // --- éšæ®µ 2.5: ç­‰å¾…è½‰ç›¤ ---
                    instruction.innerText = isWinner ? "ã€è§€è³æ™‚åˆ»ã€‘æ•—è€…æ­£åœ¨æ¥å—å¯©åˆ¤" : "ã€æ¥å—å‘½é‹ã€‘è«‹é»æ“Šè½‰ç›¤æŠ½å–æ‡²ç½°";
                    if(btnGoGift) btnGoGift.innerText = "ç­‰å¾…æ‡²ç½°æŠ½å–... (LOCKED)";

                    if (btnSpin) {
                        if (isWinner) {
                            btnSpin.innerText = "è§€è³ä¸­...";
                        } else {
                            btnSpin.disabled = false;
                            btnSpin.style.opacity = 1;
                            btnSpin.style.cursor = "pointer";
                            btnSpin.innerText = "é–‹å§‹è½‰ç›¤ (SPIN)";
                        }
                    }
                }
            }
        }

        window.submitOnePunishment = () => {
            const p1 = document.getElementById('punishment-input-one').value.trim();
            if (!p1) return alert("è«‹è¼¸å…¥æ‡²ç½°ï¼");
            
            db.ref(`game/punishmentSubmissions/${myName}`).set(p1);
        };

        window.spinPunishmentWheel = () => {
            const options = Object.values(serverData.punishmentSubmissions || {});
            const display = document.getElementById('roulette-display');
            const btn = document.getElementById('spin-btn');
            
            if (options.length === 0) return;

            // é˜²æ­¢é‡è¤‡é»æ“Š
            btn.disabled = true;

            let counter = 0;
            let speed = 50;
            
            const run = () => {
                const rand = options[Math.floor(Math.random() * options.length)];
                display.innerText = rand;
                counter++;
                if (counter < 35) { // è½‰ä¹…ä¸€é»é»
                    setTimeout(run, speed);
                    speed += 10; 
                } else {
                    display.style.color = 'red';
                    display.style.transform = 'scale(1.2)';
                    
                    // --- é—œéµï¼šè½‰å®Œå¾Œï¼Œå°‡çµæœå¯«å…¥è³‡æ–™åº«ï¼Œè§¸ç™¼å…¨å ´è§£é– ---
                    setTimeout(() => {
                        db.ref('game').update({
                            punishmentResult: rand
                        });
                    }, 500);
                    // --------------------------------------------------
                }
            };
            run();
        };

        // --- Task 4: å‰å¾€ç¦®ç‰©é é¢ï¼Œç”Ÿæˆé †åº ---
        window.goToGiftSection = () => { 
            // åªæœ‰ç¬¬ä¸€å€‹è§¸ç™¼çš„äººè² è²¬ç”Ÿæˆé †åº (é€™è£¡ç°¡åŒ–ç‚ºæ¯æ¬¡é»æ“Šéƒ½å˜—è©¦æ›´æ–°ï¼Œå¦‚æœå·²å­˜åœ¨å‰‡ä¸è¦†è“‹)
            db.ref('game').transaction(game => {
                if (game) {
                    game.state = 7;
                    if (!game.giftDrawOrder) {
                        const winner = game.finalWinner;
                        const players = Object.keys(game.players);
                        
                        // åˆ†çµ„
                        const winList = players.filter(n => {
                            const r = game.players[n].role;
                            if (winner === 'Evil') return r === 'Undercover' || r === 'Assassin';
                            return r === 'Detective' || r === 'God';
                        });
                        const loseList = players.filter(n => !winList.includes(n));
                        
                        // æ´—ç‰Œ
                        const shuffle = (arr) => arr.sort(() => Math.random() - 0.5);
                        game.giftDrawOrder = shuffle(winList).concat(shuffle(loseList));
                        game.currentDrawIndex = 0;
                        game.takenGifts = []; // å·²ç¶“è¢«æŠ½èµ°çš„ç¦®ç‰©
                    }
                }
                return game;
            });
            window.showLocalPage(7); 
        };

/* --- Task 3 & 4: ç¦®ç‰©é é¢é‚è¼¯ --- */
        function initGiftPage() { 
            const container = document.getElementById('my-gift-select'); 
            container.innerHTML = ''; 
            
            // ç”Ÿæˆæ•¸å­—æŒ‰éˆ•
            for(let i=1; i<=8; i++) { 
                const btn = document.createElement('div'); 
                btn.className = 'number-btn'; 
                btn.innerText = i; 
                btn.id = `gift-btn-${i}`;
                
                // å¦‚æœå·²ç¶“è¢«é¸èµ°ï¼Œé¡¯ç¤ºç¦ç”¨
                if (serverData.takenGifts && serverData.takenGifts.includes(i)) {
                    btn.classList.add('disabled');
                    btn.innerHTML = 'âŒ';
                }

                btn.onclick = () => { 
                    if (btn.classList.contains('disabled')) return;
                    document.querySelectorAll('.number-btn').forEach(c => c.classList.remove('selected')); 
                    btn.classList.add('selected'); 
                    myGiftNum = i; 
                    
                    // æª¢æŸ¥æ˜¯å¦è¼ªåˆ°æˆ‘
                    checkMyTurn();
                }; 
                container.appendChild(btn); 
            } 
            
            // --- é¡¯ç¤ºé †åºèˆ‡ MVP å¡ç‰‡ ---
            const priorityDiv = document.getElementById('gift-priority-display');
            priorityDiv.innerHTML = '';
            
            if (serverData && serverData.giftDrawOrder) {
                const order = serverData.giftDrawOrder;
                const idx = serverData.currentDrawIndex || 0;
                
                // é¡¯ç¤ºç•¶å‰ç©å®¶
                if (idx < order.length) {
                    const currentPlayer = order[idx];
                    let turnHTML = `<p>ç•¶å‰æŠ½çé †åºï¼š<br>`;
                    
                    // --- ä¿®æ”¹é» 2ï¼šå­—é«”ç”± 1.5rem ç¸®å°è‡³ 1.1rem ---
                    turnHTML += `<span style="font-size:1rem; background:var(--ink); color:#fff; padding:3px 10px; border-radius:4px; display:inline-block; margin-top:5px; vertical-align:middle;">${currentPlayer}</span> çš„å›åˆ</p>`;
                    
                    priorityDiv.innerHTML += turnHTML;
                    
                    checkMyTurn();
                } else {
                    priorityDiv.innerHTML += `<p>æŠ½ççµæŸï¼</p>`;
                    document.getElementById('draw-section').style.display = 'none';
                }

                // --- ä¿®æ”¹é» 1 ç¢ºèªï¼šMVP åˆ¤å®šèˆ‡å¡ç‰‡é¡¯ç¤º (é‚è¼¯èˆ‡çµæœé ä¸€è‡´) ---
                const isEvilWin = (serverData.finalWinner === 'Evil');
                let mvpName = null;

                if (isEvilWin) {
                     // å£äººè´ï¼šMVPæ˜¯åˆºå®¢
                     const assassinEntry = Object.entries(serverData.players).find(([n, p]) => p.role === 'Assassin');
                     if (assassinEntry) mvpName = assassinEntry[0];
                } else {
                     // å¥½äººè´ï¼šMVPæ˜¯ç¥
                     const godEntry = Object.entries(serverData.players).find(([n, p]) => p.role === 'God');
                     if (godEntry) mvpName = godEntry[0];
                }

                // åªæœ‰ MVP æœ¬äººçœ‹å¾—åˆ°é€™å¼µå¡
                if (mvpName === myName) {
                    priorityDiv.innerHTML += `<div class="special-card-display">
                        <h3 style="margin:0; border:none; color:#fff;">ğŸƒ æ€ªç¦®ç‰©å¼·è¡Œäº¤æ›å¡</h3>
                        <small>æŒæœ‰è€…å°ˆå±¬å¯è¦‹</small>
                    </div>`;
                }
            }
        }

function checkMyTurn() {
            if (!serverData.giftDrawOrder) return;
            const idx = serverData.currentDrawIndex || 0;
            const currentPlayer = serverData.giftDrawOrder[idx];
            const btnDraw = document.getElementById('btn-draw-gift');
            const drawSection = document.getElementById('draw-section');

            // --- ä¿®æ”¹é»ï¼šåªè¦åå­—å°äº†ï¼Œå°±ç›´æ¥é–‹æ”¾æŠ½ç (ç§»é™¤ myGiftNum çš„åˆ¤æ–·) ---
            if (myName === currentPlayer) {
                drawSection.style.display = 'block';
                btnDraw.disabled = false;
                btnDraw.innerText = "é–‹å§‹æŠ½ç";
                btnDraw.style.opacity = 1;
            } else {
                // ä¸æ˜¯æˆ‘çš„å›åˆ
                drawSection.style.display = 'block';
                btnDraw.disabled = true;
                btnDraw.innerText = `ç­‰å¾… ${currentPlayer} æŠ½ç...`;
                btnDraw.style.opacity = 0.5;
            }
        }
        
// Task 4: æŠ½çé‚è¼¯æœ€çµ‚ç‰ˆ (ç„¡é ˆé¸è™Ÿ + å¹²æ“¾å¡ + é§­å®¢é‡ç½® + çµå±€è·³è½‰)
        window.luckyDraw = () => { 
            // --- ä¿®æ”¹é»ï¼šç§»é™¤äº† if (!myGiftNum) return; é€™è¡Œï¼Œæ²’é¸è™Ÿç¢¼ä¹Ÿèƒ½è·‘ ---
            
            // 1. ç¢ºèªæ˜¯å¦è¼ªåˆ°æˆ‘
            const idx = serverData.currentDrawIndex || 0;
            if (serverData.giftDrawOrder[idx] !== myName) return;

            // --- ã€å¹²æ“¾å¡åˆ¤å®šç³»çµ± (æ©Ÿç‡ 0.2)ã€‘ ---
            if (Math.random() < 0.2) {
                const events = [
                    "âš  æƒ…å ±æ´©æ¼ âš \n(INTERCEPTED)\n\nè«‹èˆ‡ã€Œå·¦æ‰‹é‚Šã€çš„äºº\näº’æ›å¸¶ä¾†çš„ç¦®ç‰©ï¼",
                    "âš  é§­å®¢å…¥ä¾µ âš \n(SYSTEM FAILURE)\n\nç³»çµ±å´©æ½°ï¼æœ¬è¼ªç„¡æ•ˆï¼\næ‰€æœ‰äººæ­¸é‚„ç¦®ç‰©\né †åºé‡æ´—ï¼Œå…¨éƒ¨é‡ä¾†ï¼",
                    "âš  åŒ¿åèˆ‰å ± âš \n(WHISTLEBLOWER)\n\næŒ‡å®šç¾å ´ä»»æ„ä¸€äºº\nç«‹åˆ»æ‹†é–‹ä»–çš„ç¦®ç‰©ï¼"
                ];
                const eventText = events[Math.floor(Math.random() * events.length)];
                
                const overlay = document.getElementById('interference-fullscreen');
                const overlayText = document.getElementById('interference-text');
                
                overlayText.innerText = eventText;
                overlayText.style.fontSize = "1.5rem";
                overlayText.style.lineHeight = "2";
                overlay.style.display = 'flex';
                
                document.getElementById('sfx-alert').play().catch(e=>{});

                // --- é§­å®¢å¡è‡ªå‹•é‡ç½® ---
                if (eventText.includes("é§­å®¢å…¥ä¾µ")) {
                    setTimeout(() => {
                        let newOrder = [...serverData.giftDrawOrder];
                        newOrder.sort(() => Math.random() - 0.5);

                        db.ref('game').update({
                            takenGifts: null,
                            currentDrawIndex: 0,
                            giftDrawOrder: newOrder
                        });
                        
                        alert("ğŸ’€ ç³»çµ±å·²é‡ç½®ï¼æ‰€æœ‰ç¦®ç‰©è«‹æ­¸é‚„åŸä¸»ï¼Œæº–å‚™é‡æ–°é–‹å§‹ï¼");
                    }, 1000); 
                }
                
                return; // æœ‰å¹²æ“¾å°±ä¸ç¹¼çºŒæŠ½
            }
            // ------------------------------------------

            // 2. æ­£å¸¸æŠ½çæµç¨‹
            const resultDiv = document.getElementById('draw-result'); 
            resultDiv.innerHTML = '<p>è¨Šè™Ÿæ¥æ”¶ä¸­...</p>'; 
            
            setTimeout(() => { 
                const taken = serverData.takenGifts || [];
                let possible = []; 
                for(let i=1; i<=8; i++) { 
                    // æ’é™¤å·²ç¶“è¢«æŠ½èµ°çš„
                    if (!taken.includes(i)) {
                        // é€™è£¡åšå€‹åˆ¤æ–·ï¼šå¦‚æœç©å®¶æœ‰ã€Œè‡ªé¡˜ã€é»æ“Šè‡ªå·±çš„è™Ÿç¢¼ (myGiftNum æœ‰å€¼)ï¼Œå°±å¹«ä»–æ’é™¤
                        // å¦‚æœç©å®¶æ²’é» (myGiftNum æ˜¯ null)ï¼Œå°±ä¸æ’é™¤
                        if (myGiftNum && i === myGiftNum) {
                            continue; 
                        }
                        possible.push(i); 
                    }
                } 
                
                // é˜²å‘†ï¼šå¦‚æœçœŸçš„æ²’ç¦®ç‰©å¯æŠ½ (ä¾‹å¦‚åªå‰©è‡ªå·±çš„ï¼Œæˆ–è€…å…¨éƒ¨éƒ½æŠ½å®Œäº†)
                if (possible.length === 0) {
                     for(let i=1; i<=8; i++) { 
                        if (!taken.includes(i)) possible.push(i);
                     }
                }

                const drawn = possible[Math.floor(Math.random() * possible.length)]; 
                
                const newTaken = [...taken, drawn];
                db.ref('game').update({
                    takenGifts: newTaken,
                    currentDrawIndex: idx + 1
                });

                resultDiv.innerHTML = `
                    <div class="case-file">
                        <h3>ğŸ æ­å–œç²å¾—</h3>
                        <h1 style="font-size: 4rem; color: var(--accent-red); border:none;">${drawn}</h1>
                        <p>è™Ÿç¦®ç‰©</p>
                    </div>
                    <button class="btn" style="margin-top:20px; background: var(--success-green); border-color: var(--success-green);" onclick="showGlobalPage('8')">
                        æœ¬éŠæˆ²çµæŸæ’’èŠ±ï¼Œå‰å¾€æ¢éšª ğŸŒ¸
                    </button>
                `;
            }, 1000); 
        };

        window.hardReset = () => { 
            let pass = prompt("ç³»çµ±é‡ç½®éœ€è¦ç®¡ç†å“¡å¯†ç¢¼ï¼š");
            if (pass === "1264") {
                if(confirm("ã€è­¦å‘Šã€‘é€™å°‡æ¸…ç©ºæ‰€æœ‰ç©å®¶è³‡æ–™ä¸¦é‡æ–°é–‹å§‹ã€‚ç¢ºå®šå—ï¼Ÿ")) { 
                    localStorage.clear();
                    db.ref('game').set({ state: 0 }).then(() => location.reload()); 
                } 
            } else {
                if (pass !== null) alert("å¯†ç¢¼éŒ¯èª¤");
            }
        };

        // --- æ–°å¢ï¼šç‰¹å·¥æ¨ç†ç­†è¨˜åŠŸèƒ½ (JavaScript) ---
        const NOTEBOOK_KEY = 'agent_notebook_data';
        const STATUS_OPTIONS = [
            { text: "â“ æœªçŸ¥", color: "#666" },
            { text: "ğŸŸ¢ å¥½äºº", color: "var(--success-green)", style: "color:white;" },
            { text: "ğŸ”´ å£äºº", color: "var(--fail-red)", style: "color:white;" },
            { text: "â˜ ï¸ åˆºå®¢", color: "#000", style: "color:white; border: 1px solid red;" },
            { text: "ğŸ‘‘ ç¥", color: "purple", style: "color:white;" }
        ];

        function toggleNotebook() {
            const modal = document.getElementById('notebook-modal');
            const isHidden = (modal.style.display === 'none');
            
            if (isHidden) {
                renderNotebookEntries();
                // è¼‰å…¥å‚™å¿˜éŒ„
                const data = JSON.parse(localStorage.getItem(NOTEBOOK_KEY) || '{}');
                document.getElementById('notebook-memo').value = data.memo || '';
                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
            }
        }

        function renderNotebookEntries() {
            const container = document.getElementById('notebook-entries');
            container.innerHTML = '';
            
            const data = JSON.parse(localStorage.getItem(NOTEBOOK_KEY) || '{}');
            const statuses = data.statuses || {};

            PLAYERS_LIST.forEach(player => {
                if (player === myName) return; // ä¸é¡¯ç¤ºè‡ªå·±

                const row = document.createElement('div');
                row.className = 'note-row';
                
                const currentStatusIdx = statuses[player] || 0;
                const status = STATUS_OPTIONS[currentStatusIdx];

                row.innerHTML = `
                    <div class="note-name">${player}</div>
                    <div class="note-status-btn" style="background:${status.color}; ${status.style || ''}" 
                         onclick="cycleNoteStatus('${player}')">${status.text}</div>
                `;
                container.appendChild(row);
            });
        }

        function cycleNoteStatus(player) {
            const data = JSON.parse(localStorage.getItem(NOTEBOOK_KEY) || '{}');
            if (!data.statuses) data.statuses = {};
            
            let current = data.statuses[player] || 0;
            current = (current + 1) % STATUS_OPTIONS.length;
            data.statuses[player] = current;
            
            localStorage.setItem(NOTEBOOK_KEY, JSON.stringify(data));
            renderNotebookEntries();
        }

        function saveNotebook() {
            const data = JSON.parse(localStorage.getItem(NOTEBOOK_KEY) || '{}');
            data.memo = document.getElementById('notebook-memo').value;
            localStorage.setItem(NOTEBOOK_KEY, JSON.stringify(data));
            alert("ç­†è¨˜å·²ä¿å­˜ (Saved Locally)");
            toggleNotebook();
        }
    </script>
</body>
</html>




